package controller;

import enumerations.*;
import exceptions.MultipleValidationErrorsException;
import model.GameModel;
import model.card.Card;
import model.card.CardPile;
import model.card.cardsType.*;
import model.card.cardsType.ForReadJson.Meteor;
import model.flightBoard.FlightBoard;
import model.player.Player;
import model.shipBoard.ShipBoard;
import model.shipBoard.ShipBoardSpace;
import model.tiles.GameTile;
import model.tiles.componentTile.*;
import network.messages.*;
import network.structure.ServerMain;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import support.Couple;

import java.io.IOException;
import java.lang.reflect.Field;
import java.util.*;

import static org.mockito.Mockito.*;

class ControllerTest {

    private ServerMain server;
    private Controller controller;
    private GameModel gameModel;

    @BeforeEach
    void setUp() {
        server = mock(ServerMain.class);
        gameModel = mock(GameModel.class);
    }

    @AfterEach
    void tearDown() {
    }

    @Test
    public void handleAbandonedShipChoiceMessageTest0() throws IOException {
        controller = spy(new Controller(server));
        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        controller.handleAbandonedShipChoiceMessage("Player1", abandonedShip, "dock");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state")
        ));

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleAbandonedShipChoiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);


        when(gameModel.getGameState()).thenReturn(GameState.ABANDONED_SHIP);
        when(abandonedShip.processAbandonedShipChoice(player1)).thenReturn(true);

        controller.handleAbandonedShipChoiceMessage("Player1", abandonedShip, "dock");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn: Player2")

        ));

        verify(controller, times(1)).update(any(Message.class));
        verify(abandonedShip, never()).processAbandonedShipChoice(any(Player.class));
    }

    @Test
    public void handleAbandonedShipChoiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ABANDONED_SHIP);
        when(abandonedShip.processAbandonedShipChoice(player1)).thenReturn(false);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);



        controller.handleAbandonedShipChoiceMessage("Player1", abandonedShip, "dock");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You don't have enough figures")

        ));
    }

    @Test
    public void handleAbandonedShipChoiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        Player player2 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ABANDONED_SHIP);
        when(abandonedShip.processAbandonedShipChoice(player1)).thenReturn(true);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);



        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);



        controller.handleAbandonedShipChoiceMessage("Player1", abandonedShip, "dock");

        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));

        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleAbandonedShipChoiceMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        Player player2 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ABANDONED_SHIP);
        when(abandonedShip.processAbandonedShipChoice(player1)).thenReturn(true);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleAbandonedShipChoiceMessage("Player1", abandonedShip, "skip");

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleAbandonedShipChoiceMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        Player player2 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ABANDONED_SHIP);
        when(abandonedShip.processAbandonedShipChoice(player1)).thenReturn(true);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleAbandonedShipChoiceMessage("Player1", abandonedShip, "skip");

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleAbandonedShipChoiceMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        Player player2 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ABANDONED_SHIP);
        when(abandonedShip.processAbandonedShipChoice(player1)).thenReturn(true);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleAbandonedShipChoiceMessage("Player1", abandonedShip, "ok");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("This choice is not correct")
        ));
    }


    @Test
    public void handleAbandonedStationChoiceMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleAbandonedStationChoiceMessage("Player1", abandonedStation, "dock");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state")
        ));

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleAbandonedStationChoiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ABANDONED_STATION);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleAbandonedStationChoiceMessage("Player2", abandonedStation, "dock");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        //((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn: Player1")

        ));
    }

    @Test
    public void handleAbandonedStationChoiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ABANDONED_STATION);
        when(abandonedStation.processAbandonedStationChoice(player1)).thenReturn(false);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleAbandonedStationChoiceMessage("Player1", abandonedStation, "dock");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You don't have enough figures")

        ));
    }

    @Test
    public void handleAbandonedStationChoiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        Player player2 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Color> tempColor = new ArrayList<>(Arrays.asList(Color.RED, Color.BLUE));
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ABANDONED_STATION);
        when(abandonedStation.processAbandonedStationChoice(player1)).thenReturn(true);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(abandonedStation.getColorOfGoodsTaken()).thenReturn(tempColor);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleAbandonedStationChoiceMessage("Player1", abandonedStation, "dock");

        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GainedGoodsMessage &&
                        ((GainedGoodsMessage) message).getClientId().equals("Player1")
        ));

        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleAbandonedStationChoiceMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        Player player2 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ABANDONED_STATION);
        when(abandonedStation.processAbandonedStationChoice(player1)).thenReturn(true);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleAbandonedStationChoiceMessage("Player1", abandonedStation, "skip");

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1") &&
                        ((DrawnCardMessage) message).getCard().equals(abandonedStation)

        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleAbandonedStationChoiceMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        Player player2 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ABANDONED_STATION);
        when(abandonedStation.processAbandonedStationChoice(player1)).thenReturn(true);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleAbandonedStationChoiceMessage("Player1", abandonedStation, "skip");

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleAbandonedStationChoiceMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        Player player2 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ABANDONED_STATION);
        when(abandonedStation.processAbandonedStationChoice(player1)).thenReturn(true);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleAbandonedStationChoiceMessage("Player1", abandonedStation, "ok");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("This choice is not correct")
        ));
    }


    @Test
    public void handleActivateCannonMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateCannonMessage("Player1", smugglers, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state")
        ));

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateCannonMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateCannonMessage("Player2", smugglers, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        //((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn: Player1")

        ));
    }

    @Test
    public void handleActivateCannonMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateCannonMessage("Player1", smugglers, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You have no batteries")

        ));
    }

    @Test
    public void handleActivateCannonMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateCannonMessage("Player1", smugglers,4,3);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateCannonMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateCannonMessage("Player1", smugglers,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The cannon in space") &&
                        message.getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateCannonMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(3);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateCannonMessage("Player1", smugglers,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates") &&
                        message.getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleActivateCannonMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateCannonMessage("Player1", meteorSwarmCard,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("Can't activate cannon because meteor size is 1")
        ));
    }


    @Test
    public void handleActivateCannonMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(2);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateCannonMessage("Player1", meteorSwarmCard,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("You have no batteries")
        ));
    }

    @Test
    public void handleActivateCannonMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(2);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateCannonMessage("Player1", meteorSwarmCard,4,3);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateCannonMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(2);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateCannonMessage("Player1", meteorSwarmCard,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The cannon in space") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateCannonMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(2);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(3);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateCannonMessage("Player1", meteorSwarmCard,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates ") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateEngineMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        OpenSpace openSpace = mock(OpenSpace.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateEngineMessage("Player1", openSpace, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state")
        ));

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateEngineMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        OpenSpace openSpace = mock(OpenSpace.class);
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateEngineMessage("Player2", openSpace, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        //((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn: Player1")

        ));
    }

    @Test
    public void handleActivateEngineMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        OpenSpace openSpace = mock(OpenSpace.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateEngineMessage("Player1", openSpace, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You have no batteries")

        ));
    }

    @Test
    public void handleActivateEngineMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        OpenSpace openSpace = mock(OpenSpace.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateEngine(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateEngineMessage("Player1", openSpace,4,3);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateEngineMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        OpenSpace openSpace = mock(OpenSpace.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateEngine(3,4)).thenReturn(2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateEngineMessage("Player1", openSpace,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The engine in space") &&
                        message.getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateEngineMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        OpenSpace openSpace = mock(OpenSpace.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateEngine(3,4)).thenReturn(3);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateEngineMessage("Player1", openSpace,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates") &&
                        message.getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleActivateShieldMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", meteorSwarmCard, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state")
        ));

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateShieldMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(2);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player2", meteorSwarmCard, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        //((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("Can't activate shield because meteor size is large") &&
                        message.getClientId().equals("Player2")

        ));
    }

    @Test
    public void handleActivateShieldMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", meteorSwarmCard, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        //((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("You have no batteries") &&
                        message.getClientId().equals("Player1")

        ));
    }

    @Test
    public void handleActivateShieldMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", meteorSwarmCard, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateShieldMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", meteorSwarmCard, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The shield in space ")
        ));
    }

    @Test
    public void handleActivateShieldMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(3);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", meteorSwarmCard, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates")
        ));
    }

    @Test
    public void handleActivateShieldMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", combatZone, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        //((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("You have no batteries") &&
                        message.getClientId().equals("Player1")

        ));
    }

    @Test
    public void handleActivateShieldMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", combatZone, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateShieldMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", combatZone, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The shield in space ")
        ));
    }

    @Test
    public void handleActivateShieldMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(3);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", combatZone, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates")
        ));
    }

    @Test
    public void handleActivateShieldMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(2,1));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", piratesCard, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        //((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("Can't activate shield because cannon fire is heavy") &&
                        message.getClientId().equals("Player1")

        ));
    }

    @Test
    public void handleActivateShieldMessageTest11() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(1,2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", piratesCard, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        //((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("You have no batteries") &&
                        message.getClientId().equals("Player1")

        ));
    }

    @Test
    public void handleActivateShieldMessageTest12() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(1,2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", piratesCard, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleActivateShieldMessageTest13() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(1,2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", piratesCard, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The shield in space ")
        ));
    }

    @Test
    public void handleActivateShieldMessageTest14() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(1,2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(3);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleActivateShieldMessage("Player1", piratesCard, 4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates")
        ));
    }

    @Test
    public void handleChangeTileDirectionMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleChangeTileDirectionMessage("Player1", "nord");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleChangeTileDirectionMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleChangeTileDirectionMessage("Player1", "a");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("Incorrect direction") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleChangeTileDirectionMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player1.getTileInHand()).thenReturn(null);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleChangeTileDirectionMessage("Player1", "nord");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You don't have a tile in hand") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleChangeTileDirectionMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = mock(Player.class);
        Cannon cannon = mock(Cannon.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player1.getTileInHand()).thenReturn(cannon);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleChangeTileDirectionMessage("Player1", "nord");

        verify(controller).update(argThat(message ->
                message instanceof PickedTileMessage &&
                        message.getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleChooseFlightTypeMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleChooseFlightTypeMessage("Player1", FlightType.STANDARD_FLIGHT);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleChooseFlightTypeMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.LOGIN);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleChooseFlightTypeMessage("Player1", FlightType.STANDARD_FLIGHT);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("The flight type for this game is already set.") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleChooseFlightTypeMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.LOGIN);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getFlightType()).thenReturn(null);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleChooseFlightTypeMessage("Player1", FlightType.STANDARD_FLIGHT);

        verify(controller).update(argThat(message ->
                message instanceof ChooseFlightTypeMessage &&
                        message.getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleCombatZoneChoiceMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZoneCard = mock(CombatZone.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleCombatZoneChoiceMessage("Player1", combatZoneCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleCombatZoneChoiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZoneCard = mock(CombatZone.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteor.getDirection()).thenReturn("nord");
        when(combatZoneCard.getCounter()).thenReturn(1);

        HashMap<String, Boolean> hashMap = new HashMap<>();
        hashMap.put("nord", false);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.getCoveredDirection()).thenReturn(hashMap);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleCombatZoneChoiceMessage("Player1", combatZoneCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        //((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        message.getClientId().equals("Player1")

        ));
    }

    @Test
    public void handleCombatZoneChoiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZoneCard = mock(CombatZone.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(2);
        when(meteor.getDirection()).thenReturn("nord");
        when(combatZoneCard.getCounter()).thenReturn(1);

        HashMap<String, Boolean> hashMap = new HashMap<>();
        hashMap.put("nord", false);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.getCoveredDirection()).thenReturn(hashMap);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleCombatZoneChoiceMessage("Player1", combatZoneCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        //((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        message.getClientId().equals("Player1")

        ));
    }

    @Test
    public void handleCombatZoneChoiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZoneCard = mock(CombatZone.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(2);
        when(meteor.getDirection()).thenReturn("nord");
        when(combatZoneCard.getCounter()).thenReturn(1);

        HashMap<String, Boolean> hashMap = new HashMap<>();
        hashMap.put("nord", false);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.getCoveredDirection()).thenReturn(hashMap);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleCombatZoneChoiceMessage("Player1", combatZoneCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        //((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        message.getClientId().equals("Player1")

        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player1")

        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        message.getClientId().equals("Player1")

        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        message.getClientId().equals("Player1")

        ));
    }

    @Test
    public void handleCombatZoneChoiceMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException, MultipleValidationErrorsException {
        controller = spy(new Controller(server));
        CombatZone combatZoneCard = mock(CombatZone.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(2);
        when(meteor.getDirection()).thenReturn("nord");
        when(combatZoneCard.getCounter()).thenReturn(1);

        HashMap<String, Boolean> hashMap = new HashMap<>();
        hashMap.put("nord", false);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.getCoveredDirection()).thenReturn(hashMap);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard2.getCorrectShip()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        //doThrow(new RemoteException("Test exception")).when(mockClient).sendMessage(any(Message.class));
        ArrayList<String> exceptions = new ArrayList<>(Arrays.asList("exc1", "exc2", "exc3"));
        doThrow(new MultipleValidationErrorsException(exceptions)).when(shipBoard1).validateShipBoard();

        controller.handleCombatZoneChoiceMessage("Player1", combatZoneCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipErrorsMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        message.getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleCombatZoneChoiceMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException, MultipleValidationErrorsException {
        controller = spy(new Controller(server));
        CombatZone combatZoneCard = mock(CombatZone.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(2);
        when(meteor.getDirection()).thenReturn("nord");
        when(combatZoneCard.getCounter()).thenReturn(1);

        HashMap<String, Boolean> hashMap = new HashMap<>();
        hashMap.put("nord", false);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.getCoveredDirection()).thenReturn(hashMap);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getCorrectShip()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        //doThrow(new RemoteException("Test exception")).when(mockClient).sendMessage(any(Message.class));
        ArrayList<String> exceptions = new ArrayList<>(Arrays.asList("exc1", "exc2", "exc3"));
        doThrow(new MultipleValidationErrorsException(exceptions)).when(shipBoard2).validateShipBoard();

        controller.handleCombatZoneChoiceMessage("Player1", combatZoneCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipErrorsMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        message.getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleDefeatedPiratesMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates pirateCard = mock(Pirates.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleDefeatedPiratesMessage("Player1", pirateCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleDefeatedPiratesMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates pirateCard = mock(Pirates.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        defeatedPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleDefeatedPiratesMessage("Player1", pirateCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn:") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleDefeatedPiratesMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates pirateCard = mock(Pirates.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleDefeatedPiratesMessage("Player1", pirateCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleDefeatedPiratesMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(1,1));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        HashMap<String, Boolean> hashMap1 = new HashMap<>();
        hashMap1.put("nord", false);

        HashMap<String, Boolean> hashMap2 = new HashMap<>();
        hashMap2.put("nord", true);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getCoveredDirection()).thenReturn(hashMap1);

        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard2.getCoveredDirection()).thenReturn(hashMap2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleDefeatedPiratesMessage("Player1", piratesCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleDefeatedPiratesMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException, MultipleValidationErrorsException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        HashMap<String, Boolean> hashMap1 = new HashMap<>();
        hashMap1.put("nord", false);

        HashMap<String, Boolean> hashMap2 = new HashMap<>();
        hashMap2.put("nord", true);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getCoveredDirection()).thenReturn(hashMap1);

        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard2.getCoveredDirection()).thenReturn(hashMap2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleDefeatedPiratesMessage("Player1", piratesCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleDefeatedPiratesMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException, MultipleValidationErrorsException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        HashMap<String, Boolean> hashMap1 = new HashMap<>();
        hashMap1.put("nord", false);

        HashMap<String, Boolean> hashMap2 = new HashMap<>();
        hashMap2.put("nord", true);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getCoveredDirection()).thenReturn(hashMap1);

        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(shipBoard1.getCorrectShip()).thenReturn(true);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard2.getCoveredDirection()).thenReturn(hashMap2);
        when(shipBoard2.getCorrectShip()).thenReturn(false);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        ArrayList<String> exceptions = new ArrayList<>(Arrays.asList("exc1", "exc2", "exc3"));
        doThrow(new MultipleValidationErrorsException(exceptions)).when(shipBoard2).validateShipBoard();

        controller.handleDefeatedPiratesMessage("Player1", piratesCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipErrorsMessage &&
                        ((ShowShipErrorsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleFase1ChoiceMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase1ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFase1ChoiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_1);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase1ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn:") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFase1ChoiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);


        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_1);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player2);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase1ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleFase1ChoiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);

        Object[] faseOne = new Object[3];
        faseOne[2] = 1;
        when(combatZone.getFaseOne()).thenReturn(faseOne);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_1);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase1ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleFase2ChoiceMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase2ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFase2ChoiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_2);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase2ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn:") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFase2ChoiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);


        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_2);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player2);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase2ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleFase2ChoiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);
        when(combatZone.getLevel()).thenReturn(1);

        Object[] faseOne = new Object[3];
        faseOne[2] = 1;
        when(combatZone.getFaseOne()).thenReturn(faseOne);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_2);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.getNumFigures()).thenReturn(0);
        when(shipBoard1.getHasBrownAlien()).thenReturn(false);
        when(shipBoard1.getHasPurpleAlien()).thenReturn(false);

        when(player2.getProceed()).thenReturn(false);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase2ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleFase2ChoiceMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);
        when(combatZone.getLevel()).thenReturn(1);

        Object[] faseTwo = new Object[3];
        faseTwo[2] = 1;
        when(combatZone.getFaseTwo()).thenReturn(faseTwo);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_2);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.getNumFigures()).thenReturn(1);
        when(shipBoard1.getHasBrownAlien()).thenReturn(false);
        when(shipBoard1.getHasPurpleAlien()).thenReturn(false);

        when(player2.getProceed()).thenReturn(false);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase2ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFase2ChoiceMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);
        when(combatZone.getLevel()).thenReturn(2);

        Object[] faseTwo = new Object[3];
        faseTwo[2] = 1;
        when(combatZone.getFaseTwo()).thenReturn(faseTwo);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_2);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);

        when(player2.getProceed()).thenReturn(false);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase2ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFase2ChoiceMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);
        when(combatZone.getLevel()).thenReturn(2);

        Object[] faseTwo = new Object[3];
        faseTwo[2] = 1;
        when(combatZone.getFaseTwo()).thenReturn(faseTwo);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_2);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(1);

        when(player2.getProceed()).thenReturn(false);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase2ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleFase2ChoiceMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);
        when(combatZone.getLevel()).thenReturn(2);

        Object[] faseTwo = new Object[3];
        faseTwo[2] = 1;
        when(combatZone.getFaseTwo()).thenReturn(faseTwo);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_2);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        Color color = Color.RED;
        when(shipBoard1.rarestGoodsBlock()).thenReturn(color);
        when(shipBoard1.getNumBatteries()).thenReturn(1);

        when(player2.getProceed()).thenReturn(false);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase2ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveGoodMessage &&
                        ((AskRemoveGoodMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleFase3ChoiceMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase3ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFase3ChoiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_3);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase3ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn:") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFase3ChoiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);


        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_3);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player2);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase3ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleFase3ChoiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        CombatZone combatZone = mock(CombatZone.class);

        Object[] faseOne = new Object[3];
        faseOne[2] = 1;
        when(combatZone.getFaseOne()).thenReturn(faseOne);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.FASE_3);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFase3ChoiceMessage("Player1", combatZone);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleFinishedBuildingMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        GameEventListener listener = mock(GameEventListener.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFinishedBuildingMessage("Player1", listener);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFinishedBuildingMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        GameEventListener listener = mock(GameEventListener.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(player1.getPlayerState()).thenReturn(PlayerState.WAIT);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFinishedBuildingMessage("Player1", listener);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("You are not in turn") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFinishedBuildingMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        GameEventListener listener = mock(GameEventListener.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        ShipBoardSpace space1 = mock(ShipBoardSpace.class);
        ShipBoardSpace space2 = mock(ShipBoardSpace.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        Cannon cannon = mock(Cannon.class);
        when(player1.getTileInHand()).thenReturn(cannon);
        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(true);

        when(space1.getComponent()).thenReturn(cannon);
        when(space2.getComponent()).thenReturn(cannon);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(shipBoard1.getSpace(0,5)).thenReturn(space1);
        when(shipBoard1.getSpace(0,6)).thenReturn(space2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFinishedBuildingMessage("Player1", listener);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof Proceed2Message &&
                        ((Proceed2Message) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof Proceed2Message &&
                        ((Proceed2Message) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleFinishedBuildingMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        GameEventListener listener = mock(GameEventListener.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        ShipBoardSpace space1 = mock(ShipBoardSpace.class);
        ShipBoardSpace space2 = mock(ShipBoardSpace.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        Cannon cannon = mock(Cannon.class);
        when(player1.getTileInHand()).thenReturn(cannon);
        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(false);

        when(space1.getComponent()).thenReturn(cannon);
        when(space2.getComponent()).thenReturn(cannon);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(shipBoard1.getSpace(0,5)).thenReturn(space1);
        when(shipBoard1.getSpace(0,6)).thenReturn(space2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFinishedBuildingMessage("Player1", listener);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2)message).getMessage().equals("Waiting for other players to finish building their ships.") &&
                        ((GenericMessage2) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFinishedBuildingMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException, MultipleValidationErrorsException {
        controller = spy(new Controller(server));
        GameEventListener listener = mock(GameEventListener.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        ShipBoardSpace space1 = mock(ShipBoardSpace.class);
        ShipBoardSpace space2 = mock(ShipBoardSpace.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        Cannon cannon = mock(Cannon.class);
        when(player1.getTileInHand()).thenReturn(cannon);
        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(true);

        when(space1.getComponent()).thenReturn(cannon);
        when(space2.getComponent()).thenReturn(cannon);
        when(shipBoard1.getCorrectShip()).thenReturn(false);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard2.getCorrectShip()).thenReturn(true);

        when(shipBoard1.getSpace(0,5)).thenReturn(space1);
        when(shipBoard1.getSpace(0,6)).thenReturn(space2);

        ArrayList<String> exceptions = new ArrayList<>(Arrays.asList("exc1", "exc2", "exc3"));
        doThrow(new MultipleValidationErrorsException(exceptions)).when(shipBoard1).validateShipBoard();


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFinishedBuildingMessage("Player1", listener);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipErrorsMessage &&
                        ((ShowShipErrorsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getMessage().equals("Your ship board is correct. You have to wait the other players to finish correcting their ship.") &&
                        ((GenericMessage2) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof TempPositionMessage &&
                        ((TempPositionMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof TempPositionMessage &&
                        ((TempPositionMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleFinishedPopulateMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        GameEventListener listener = mock(GameEventListener.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFinishedPopulateMessage("Player1", listener);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFinishedPopulateMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        GameEventListener listener = mock(GameEventListener.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(player1.getPlayerState()).thenReturn(PlayerState.WAIT);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFinishedPopulateMessage("Player1", listener);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().equals("You are not in turn") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleFinishedPopulateMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        GameEventListener listener = mock(GameEventListener.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        ShipBoardSpace space1 = mock(ShipBoardSpace.class);
        ShipBoardSpace space2 = mock(ShipBoardSpace.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        Cannon cannon = mock(Cannon.class);
        when(player1.getTileInHand()).thenReturn(cannon);
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY).thenReturn(PlayerState.WAIT);
        when(player2.getPlayerState()).thenReturn(PlayerState.WAIT);

        when(space1.getComponent()).thenReturn(cannon);
        when(space2.getComponent()).thenReturn(cannon);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(shipBoard1.getSpace(0,5)).thenReturn(space1);
        when(shipBoard1.getSpace(0,6)).thenReturn(space2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFinishedPopulateMessage("Player1", listener);
    }

    @Test
    public void handleFinishedPopulateMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        GameEventListener listener = mock(GameEventListener.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        ShipBoardSpace space1 = mock(ShipBoardSpace.class);
        ShipBoardSpace space2 = mock(ShipBoardSpace.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        Cannon cannon = mock(Cannon.class);
        when(player1.getTileInHand()).thenReturn(cannon);
        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(false);

        when(space1.getComponent()).thenReturn(cannon);
        when(space2.getComponent()).thenReturn(cannon);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(shipBoard1.getSpace(0,5)).thenReturn(space1);
        when(shipBoard1.getSpace(0,6)).thenReturn(space2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleFinishedPopulateMessage("Player1", listener);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2)message).getMessage().equals("Waiting for other players to finish populate their ships.") &&
                        ((GenericMessage2) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", smugglers, 4,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", smugglers, 4,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "kk", smugglers, 4,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice is not correct") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        Cannon cannon = mock(Cannon.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cannon);

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", smugglers, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(false);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock = new ArrayList<>(Arrays.asList(Color.RED, Color.BLUE));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", smugglers, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The cargo cannot fit the goods block considered") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock = new ArrayList<>(Arrays.asList(Color.RED, Color.BLUE));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock);
        when(player1.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", smugglers, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GainedGoodsMessage &&
                        ((GainedGoodsMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", smugglers, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveGoodMessage &&
                        ((AskRemoveGoodMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleGainGoodMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2);
        when(player1.getPenaltyGoods()).thenReturn(1);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", smugglers, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveGoodMessage &&
                        ((AskRemoveGoodMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleGainGoodMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(0);
        when(player3.getPenaltyGoods()).thenReturn(0);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", smugglers, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleGainGoodMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock = new ArrayList<>(Arrays.asList(Color.RED, Color.BLUE));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock);
        when(player1.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "skip", smugglers, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GainedGoodsMessage &&
                        ((GainedGoodsMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "skip", smugglers, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveGoodMessage &&
                        ((AskRemoveGoodMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleGainGoodMessageTest11() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2);
        when(player1.getPenaltyGoods()).thenReturn(1);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "skip", smugglers, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveGoodMessage &&
                        ((AskRemoveGoodMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleGainGoodMessageTest12() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(0);
        when(player3.getPenaltyGoods()).thenReturn(0);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "skip", smugglers, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleGainGoodMessageTest13() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.PLANETS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "kk", planets, 4,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice is not correct") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest14() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.PLANETS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        Cannon cannon = mock(Cannon.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cannon);

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", planets, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest15() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.PLANETS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(false);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock = new ArrayList<>(Arrays.asList(Color.RED, Color.BLUE));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", planets, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The cargo cannot fit the goods block considered") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest16() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.PLANETS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock = new ArrayList<>(Arrays.asList(Color.RED, Color.BLUE));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock);
        when(player1.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", planets, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GainedGoodsMessage &&
                        ((GainedGoodsMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest17() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.PLANETS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();
        ArrayList<Color> tempGoodsBlock3 = new ArrayList<>(Arrays.asList(Color.RED));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2).thenReturn(tempGoodsBlock2);
        when(player2.getTempGoodsBlock()).thenReturn(tempGoodsBlock3);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", planets, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof WaitMessage &&
                        ((WaitMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest18() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.PLANETS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2).thenReturn(tempGoodsBlock2);
        when(player2.getTempGoodsBlock()).thenReturn(tempGoodsBlock2);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", planets, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleGainGoodMessageTest19() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglers = mock(Smugglers.class);
        when(smugglers.getCardType()).thenReturn(CardName.SMUGGLERS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(0);
        when(player3.getPenaltyGoods()).thenReturn(0);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", smugglers, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleGainGoodMessageTest20() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.PLANETS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock = new ArrayList<>(Arrays.asList(Color.RED, Color.BLUE));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock);
        when(player1.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "skip", planets, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GainedGoodsMessage &&
                        ((GainedGoodsMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest21() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.PLANETS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();
        ArrayList<Color> tempGoodsBlock3 = new ArrayList<>(Arrays.asList(Color.RED));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2).thenReturn(tempGoodsBlock2);
        when(player2.getTempGoodsBlock()).thenReturn(tempGoodsBlock3);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "skip", planets, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof WaitMessage &&
                        ((WaitMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest22() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.PLANETS);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2).thenReturn(tempGoodsBlock2);
        when(player2.getTempGoodsBlock()).thenReturn(tempGoodsBlock2);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "skip", planets, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleGainGoodMessageTest23() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        when(abandonedStation.getCardType()).thenReturn(CardName.ABANDONED_STATION);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "kk", abandonedStation, 4,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice is not correct") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest24() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        when(abandonedStation.getCardType()).thenReturn(CardName.ABANDONED_STATION);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        Cannon cannon = mock(Cannon.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cannon);

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", abandonedStation, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest25() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        when(abandonedStation.getCardType()).thenReturn(CardName.ABANDONED_STATION);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(false);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock = new ArrayList<>(Arrays.asList(Color.RED, Color.BLUE));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", abandonedStation, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The cargo cannot fit the goods block considered") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest26() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        when(abandonedStation.getCardType()).thenReturn(CardName.ABANDONED_STATION);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock = new ArrayList<>(Arrays.asList(Color.RED, Color.BLUE));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock);
        when(player1.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", abandonedStation, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GainedGoodsMessage &&
                        ((GainedGoodsMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest27() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        when(abandonedStation.getCardType()).thenReturn(CardName.ABANDONED_STATION);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();
        ArrayList<Color> tempGoodsBlock3 = new ArrayList<>(Arrays.asList(Color.RED));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2).thenReturn(tempGoodsBlock2);
        when(player2.getTempGoodsBlock()).thenReturn(tempGoodsBlock3);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "put", abandonedStation, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleGainGoodMessageTest30() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        when(abandonedStation.getCardType()).thenReturn(CardName.ABANDONED_STATION);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock = new ArrayList<>(Arrays.asList(Color.RED, Color.BLUE));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock);
        when(player1.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);


        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "skip", abandonedStation, 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GainedGoodsMessage &&
                        ((GainedGoodsMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleGainGoodMessageTest31() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        AbandonedStation abandonedStation = mock(AbandonedStation.class);
        when(abandonedStation.getCardType()).thenReturn(CardName.ABANDONED_STATION);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.putCargoIn(Color.RED)).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        ArrayList<Color> tempGoodsBlock1 = new ArrayList<>(Arrays.asList(Color.RED));
        ArrayList<Color> tempGoodsBlock2 = new ArrayList<>();
        ArrayList<Color> tempGoodsBlock3 = new ArrayList<>(Arrays.asList(Color.RED));

        when(player1.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);
        when(player1.getTempGoodsBlock()).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock1).thenReturn(tempGoodsBlock2).thenReturn(tempGoodsBlock2);
        when(player2.getTempGoodsBlock()).thenReturn(tempGoodsBlock3);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);

        when(gameModel.getGameState()).thenReturn(GameState.GAIN_GOODS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(Color.RED);
        when(shipBoard3.getNumBatteries()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleGainGoodMessage("Player1", "skip", abandonedStation, 5,4);


        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleMaxPlayersForGameMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleMaxPlayersForGameMessage("Player1", 2);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleMaxPlayersForGameMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.LOGIN);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleMaxPlayersForGameMessage("Player1", 2);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The players for this game are already set.")

        ));
    }

    @Test
    public void handleMaxPlayersForGameMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.LOGIN);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(1);
        when(gameModel.isInBound(5)).thenReturn(false);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleMaxPlayersForGameMessage("Player1", 5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The number of players for this game is out of bounds: it must be between 2 and")

        ));
    }

    @Test
    public void handleMaxPlayersForGameMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.LOGIN);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(1);
        when(gameModel.isInBound(4)).thenReturn(true);
        ArrayList<String> nicknames = new ArrayList<>(Arrays.asList("mario"));
        when(gameModel.getNicknames()).thenReturn(nicknames);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleMaxPlayersForGameMessage("Player1", 4);
    }

    @Test
    public void handleMeteorSwarmChoiceMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleMeteorSwarmChoiceMessage("Player1", meteorSwarmCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleMeteorSwarmChoiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);

        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteor.getDirection()).thenReturn("nord");

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(player2.getProceed()).thenReturn(false);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleMeteorSwarmChoiceMessage("Player1", meteorSwarmCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        message.getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleMeteorSwarmChoiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteor.getDirection()).thenReturn("nord");
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        when(meteorSwarmCard.getCounter()).thenReturn(1);

        HashMap<String, Boolean> hashMap1 = new HashMap<>();
        hashMap1.put("nord", false);
        HashMap<String, Boolean> hashMap2 = new HashMap<>();
        hashMap2.put("nord", true);


        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard2.isHit()).thenReturn(false);
        when(shipBoard1.getCoveredDirection()).thenReturn(hashMap1);
        when(shipBoard2.getCoveredDirection()).thenReturn(hashMap2);

        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleMeteorSwarmChoiceMessage("Player1", meteorSwarmCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleMeteorSwarmChoiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(2);
        when(meteor.getDirection()).thenReturn("nord");
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        when(meteorSwarmCard.getCounter()).thenReturn(1);

        HashMap<String, Boolean> hashMap1 = new HashMap<>();
        hashMap1.put("nord", false);
        HashMap<String, Boolean> hashMap2 = new HashMap<>();
        hashMap2.put("nord", true);


        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.checkDoubleCannonMeteor("nord", 7)).thenReturn(false);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard2.isHit()).thenReturn(false);
        when(shipBoard1.getCoveredDirection()).thenReturn(hashMap1);
        when(shipBoard2.getCoveredDirection()).thenReturn(hashMap2);

        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleMeteorSwarmChoiceMessage("Player1", meteorSwarmCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        message.getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleMeteorSwarmChoiceMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException, MultipleValidationErrorsException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(2);
        when(meteor.getDirection()).thenReturn("nord");
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        when(meteorSwarmCard.getCounter()).thenReturn(1);

        HashMap<String, Boolean> hashMap1 = new HashMap<>();
        hashMap1.put("nord", false);
        HashMap<String, Boolean> hashMap2 = new HashMap<>();
        hashMap2.put("nord", true);


        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.checkDoubleCannonMeteor("nord", 7)).thenReturn(false);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard2.isHit()).thenReturn(false);
        when(shipBoard1.getCoveredDirection()).thenReturn(hashMap1);
        when(shipBoard2.getCoveredDirection()).thenReturn(hashMap2);
        when(shipBoard1.getCorrectShip()).thenReturn(true);
        when(shipBoard2.getCorrectShip()).thenReturn(false);


        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);


        ArrayList<String> exceptions = new ArrayList<>(Arrays.asList("exc1", "exc2", "exc3"));
        doThrow(new MultipleValidationErrorsException(exceptions)).when(shipBoard2).validateShipBoard();

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleMeteorSwarmChoiceMessage("Player1", meteorSwarmCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipErrorsMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1")
        ));
//        verify(controller).update(argThat(message ->
//                message instanceof UpdateParametresMessage &&
//                        message.getClientId().equals("Player1")
//        ));
//        verify(controller).update(argThat(message ->
//                message instanceof UpdateParametresMessage &&
//                        message.getClientId().equals("Player2")
//        ));
//        verify(controller).update(argThat(message ->
//                message instanceof AskRollDiceMessage &&
//                        message.getClientId().equals("Player1")
//        ));
//        verify(controller).update(argThat(message ->
//                message instanceof AskRollDiceMessage &&
//                        message.getClientId().equals("Player2")
//        ));
    }

    @Test
    public void handleMeteorSwarmChoiceMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException, MultipleValidationErrorsException {
        controller = spy(new Controller(server));
        CombatZone combatZoneCard = mock(CombatZone.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(2);
        when(meteor.getDirection()).thenReturn("nord");
        when(combatZoneCard.getCounter()).thenReturn(1);

        HashMap<String, Boolean> hashMap = new HashMap<>();
        hashMap.put("nord", false);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        ArrayList<Player> playersPositions = new ArrayList<>();
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.getCoveredDirection()).thenReturn(hashMap);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getCorrectShip()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        //doThrow(new RemoteException("Test exception")).when(mockClient).sendMessage(any(Message.class));
        ArrayList<String> exceptions = new ArrayList<>(Arrays.asList("exc1", "exc2", "exc3"));
        doThrow(new MultipleValidationErrorsException(exceptions)).when(shipBoard2).validateShipBoard();

        controller.handleCombatZoneChoiceMessage("Player1", combatZoneCard, 7);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipErrorsMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        message.getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleOpenSpaceChoiceMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        OpenSpace openSpace = mock(OpenSpace.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleOpenSpaceChoiceMessage("Player1", openSpace);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleOpenSpaceChoiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        OpenSpace openSpace = mock(OpenSpace.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);

        when(player2.getProceed()).thenReturn(false);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleOpenSpaceChoiceMessage("Player2", openSpace);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("This choice can be made only by the player in turn:") &&
                        message.getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleOpenSpaceChoiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        OpenSpace openSpace = mock(OpenSpace.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player2);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.calculateEngineStrength()).thenReturn(0);

        when(player2.getProceed()).thenReturn(false);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleOpenSpaceChoiceMessage("Player1", openSpace);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        message.getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleOpenSpaceChoiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        OpenSpace openSpace = mock(OpenSpace.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.calculateEngineStrength()).thenReturn(0);

        when(player2.getProceed()).thenReturn(false);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleOpenSpaceChoiceMessage("Player1", openSpace);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player2")
        ));
    }


    @Test
    public void handlePickTileFromShipMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickTileFromShipMessage("Player1", 5,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePickTileFromShipMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickTileFromShipMessage("Player1", 6,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Incorrect space")

        ));
    }

    @Test
    public void handlePickTileFromShipMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickTileFromShipMessage("Player1", 5,11);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Incorrect space")

        ));
    }

    @Test
    public void handlePickTileFromShipMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.calculateEngineStrength()).thenReturn(0);
        when(shipBoard1.pickUpObjectFrom(0,6)).thenReturn(null);

        when(player2.getProceed()).thenReturn(false);


        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickTileFromShipMessage("Player1", 5,10);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The space is empty")

        ));
    }

    @Test
    public void handlePickTileFromShipMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);

        Cannon cannon = mock(Cannon.class);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.calculateEngineStrength()).thenReturn(0);
        when(shipBoard1.pickUpObjectFrom(0,6)).thenReturn(cannon);
        when(player1.getTileInHand()).thenReturn(cannon);

        when(player2.getProceed()).thenReturn(false);


        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickTileFromShipMessage("Player1", 5,10);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You have already a tile in hand")

        ));
    }

    @Test
    public void handlePickTileFromShipMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);

        Cannon cannon = mock(Cannon.class);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.calculateEngineStrength()).thenReturn(0);
        when(shipBoard1.pickUpObjectFrom(0,6)).thenReturn(cannon);
        when(player1.getTileInHand()).thenReturn(null);

        when(player2.getProceed()).thenReturn(false);


        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickTileFromShipMessage("Player1", 5,10);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof PickedTileMessage &&
                        ((PickedTileMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePickUpCardMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        GameEventListener listener = mock(GameEventListener.class);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpCardMessage("Player1", listener);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePickUpCardMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        GameEventListener listener = mock(GameEventListener.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpCardMessage("Player2", listener);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn:")

        ));
    }

    @Test
    public void handlePickUpCardMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        GameEventListener listener = mock(GameEventListener.class);
        ArrayList<Card> cards = new ArrayList<>();

        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        when(gameModel.getCardsToPlay()).thenReturn(cards);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpCardMessage("Player1", listener);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage &&
                        ((GenericMessage) message).getMessage().contains("There are no more cards. The game is finished")

        ));
    }

    @Test
    public void handlePickUpCardMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        GameEventListener listener = mock(GameEventListener.class);

        CombatZone combatZone = mock(CombatZone.class);
        Planets planets = mock(Planets.class);
        when(combatZone.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(planets.getCardType()).thenReturn(CardName.PLANETS);
        ArrayList<Card> cards = new ArrayList<>();
        ArrayList<Card> cards1 = new ArrayList<>();
        cards.add(combatZone);
        cards.add(planets);
        cards1.add(planets);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.calculateEngineStrength()).thenReturn(0);
        when(shipBoard1.pickUpObjectFrom(0,6)).thenReturn(null);

        when(player2.getProceed()).thenReturn(false);

        when(gameModel.getCardsToPlay()).thenReturn(cards).thenReturn(cards).thenReturn(cards1);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpCardMessage("Player1", listener);
    }


    @Test
    public void handlePickUpCardPileMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpCardPileMessage("Player1", 1);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePickUpCardPileMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpCardPileMessage("Player1", 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Wrong pile number")

        ));
    }

    @Test
    public void handlePickUpCardPileMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        when(gameModel.pickCardPile(1)).thenReturn(null);
        //when(controller.getGameModel()).thenReturn(gameModel);

        CardPile cardPile = mock(CardPile.class);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpCardPileMessage("Player1", 1);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The pile with ID  ")

        ));
    }

    @Test
    public void handlePickUpCardPileMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        CardPile cardPile = mock(CardPile.class);
        when(gameModel.pickCardPile(1)).thenReturn(cardPile);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(player1.getCardPileInHand()).thenReturn(cardPile);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpCardPileMessage("Player1", 1);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You have already a card pile in hand")

        ));
    }

    @Test
    public void handlePickUpCardPileMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        CardPile cardPile = mock(CardPile.class);
        when(gameModel.pickCardPile(1)).thenReturn(cardPile);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(player1.getCardPileInHand()).thenReturn(null);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpCardPileMessage("Player1", 1);
    }



    @Test
    public void handlePickUpTileMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpTileMessage("Player1", 1);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePickUpTileMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpTileMessage("Player1", -1);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("INCORRECT ID")

        ));
    }

    @Test
    public void handlePickUpTileMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        when(gameModel.getNumTiles()).thenReturn(140);

        //when(controller.getGameModel()).thenReturn(gameModel);

        Cannon cannon = mock(Cannon.class);
        when(gameModel.pickTile(1)).thenReturn(cannon);
        when(player1.getTileInHand()).thenReturn(cannon);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpTileMessage("Player1", 1);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You have already a tile in hand")

        ));
    }

    @Test
    public void handlePickUpTileMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        when(gameModel.getNumTiles()).thenReturn(140);

        //when(controller.getGameModel()).thenReturn(gameModel);

        Cannon cannon = mock(Cannon.class);
        when(gameModel.pickTile(1)).thenReturn(cannon);
        when(player1.getTileInHand()).thenReturn(null);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpTileMessage("Player1", 1);

        verify(controller).update(argThat(message ->
                message instanceof PickedTileMessage &&
                        message.getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePickUpTileMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player2);
        players.add(player1);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        when(gameModel.getNumTiles()).thenReturn(140);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.isHit()).thenReturn(true);
        when(shipBoard1.calculateEngineStrength()).thenReturn(0);
        when(shipBoard1.pickUpObjectFrom(0,6)).thenReturn(null);


        //when(controller.getGameModel()).thenReturn(gameModel);

        Cannon cannon = mock(Cannon.class);
        when(gameModel.pickTile(1)).thenReturn(null);
        when(player1.getTileInHand()).thenReturn(null);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePickUpTileMessage("Player1", 1);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The tile with ID  ") &&
                        message.getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePiratesChoiceMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Pirates piratesCard = mock(Pirates.class);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePiratesChoiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePiratesChoiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        GameEventListener listener = mock(GameEventListener.class);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);
        Pirates piratesCard = mock(Pirates.class);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePiratesChoiceMessage("Player2", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn:")
        ));
    }

    @Test
    public void handlePiratesChoiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(1,2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);
        when(piratesCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePiratesChoiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller,times(2)).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handlePiratesChoiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(1,2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);
        when(piratesCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePiratesChoiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller,times(2)).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handlePiratesChoiceMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(1,2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);
        when(piratesCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getNextPlayer()).thenReturn(player2);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(1.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePiratesChoiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handlePiratesChoiceMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(1,2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);
        when(piratesCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(1.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePiratesChoiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller,times(2)).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handlePiratesChoiceMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(1,2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);
        when(piratesCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(1.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePiratesChoiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller,times(2)).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handlePiratesChoiceMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(1,2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);
        when(piratesCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(0.5);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePiratesChoiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller,times(2)).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handlePiratesChoiceMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Pirates piratesCard = mock(Pirates.class);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(piratesCard.getCounter()).thenReturn(1);
        ArrayList<Integer> shots = new ArrayList<>(Arrays.asList(1,2));
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);
        when(piratesCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getNextPlayer()).thenReturn(player2);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(0.5);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePiratesChoiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
    }


    @Test
    public void handlePlanetsChoiceMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Planets planets = mock(Planets.class);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePlanetChoiceMessage("Player1", planets, "ok", 1);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePlanetsChoiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        GameEventListener listener = mock(GameEventListener.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLANETS);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);
        Planets planets = mock(Planets.class);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePlanetChoiceMessage("Player2", planets, "ok", 1);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn:")
        ));
    }

    @Test
    public void handlePlanetsChoiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PLANETS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePlanetChoiceMessage("Player1", planets, "ok", 1);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice is not correct")
        ));
    }

    @Test
    public void handlePlanetsChoiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PLANETS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(planets.processPlanetChoice(player1, 1)).thenReturn(false);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePlanetChoiceMessage("Player1", planets, "land", 1);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This planet choice is not correct")
        ));
    }

    @Test
    public void handlePlanetsChoiceMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when((planets.getNumOccupiedPlanets())).thenReturn(1);
        when((planets.getNumberOfPlanets())).thenReturn(3);


        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PLANETS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getNextPlayer()).thenReturn(player2);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(planets.processPlanetChoice(player1, 1)).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePlanetChoiceMessage("Player1", planets, "land", 1);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handlePlanetsChoiceMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when((planets.getNumOccupiedPlanets())).thenReturn(1);
        when((planets.getNumberOfPlanets())).thenReturn(3);


        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player1.getNickname()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        when(player2.getNickname()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PLANETS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player1.getPlayerState()).thenReturn(PlayerState.WAIT);
        when(player2.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);

        when(planets.processPlanetChoice(player1, 1)).thenReturn(true);
        when((planets.numOfPlanet("Player1"))).thenReturn(1);
        when((planets.numOfPlanet("Player2"))).thenReturn(0);
        ArrayList<Color> temp = new ArrayList<>(Arrays.asList(Color.RED));
        when(planets.choosePlanetGoods(1)).thenReturn(temp);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePlanetChoiceMessage("Player1", planets, "land", 1);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller, times(2)).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller, times(2)).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GainedGoodsMessage &&
                        ((GainedGoodsMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handlePlanetsChoiceMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when((planets.getNumOccupiedPlanets())).thenReturn(1);
        when((planets.getNumberOfPlanets())).thenReturn(3);


        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player1.getNickname()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        when(player2.getNickname()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PLANETS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player1.getPlayerState()).thenReturn(PlayerState.WAIT);
        when(player2.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);

        when(planets.processPlanetChoice(player1, 1)).thenReturn(true);
        when((planets.numOfPlanet("Player1"))).thenReturn(0);
        when((planets.numOfPlanet("Player2"))).thenReturn(0);
        ArrayList<Color> temp = new ArrayList<>(Arrays.asList(Color.RED));
        when(planets.choosePlanetGoods(1)).thenReturn(temp);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePlanetChoiceMessage("Player1", planets, "land", 1);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }


    @Test
    public void handlePlanetsChoiceMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when((planets.getNumOccupiedPlanets())).thenReturn(1);
        when((planets.getNumberOfPlanets())).thenReturn(3);


        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PLANETS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getNextPlayer()).thenReturn(player2);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(planets.processPlanetChoice(player1, 1)).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePlanetChoiceMessage("Player1", planets, "skip", 1);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handlePlanetsChoiceMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when((planets.getNumOccupiedPlanets())).thenReturn(1);
        when((planets.getNumberOfPlanets())).thenReturn(3);


        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player1.getNickname()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        when(player2.getNickname()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PLANETS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player1.getPlayerState()).thenReturn(PlayerState.WAIT);
        when(player2.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);

        when(planets.processPlanetChoice(player1, 1)).thenReturn(true);
        when((planets.numOfPlanet("Player1"))).thenReturn(1);
        when((planets.numOfPlanet("Player2"))).thenReturn(0);
        ArrayList<Color> temp = new ArrayList<>(Arrays.asList(Color.RED));
        when(planets.choosePlanetGoods(1)).thenReturn(temp);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePlanetChoiceMessage("Player1", planets, "skip", 1);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof WaitMessage &&
                        ((WaitMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GainedGoodsMessage &&
                        ((GainedGoodsMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handlePlanetsChoiceMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Planets planets = mock(Planets.class);
        when((planets.getNumOccupiedPlanets())).thenReturn(1);
        when((planets.getNumberOfPlanets())).thenReturn(3);


        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player1.getNickname()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        when(player2.getNickname()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PLANETS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player1.getPlayerState()).thenReturn(PlayerState.WAIT);
        when(player2.getPlayerState()).thenReturn(PlayerState.GAIN_GOOD);

        when(planets.processPlanetChoice(player1, 1)).thenReturn(true);
        when((planets.numOfPlanet("Player1"))).thenReturn(0);
        when((planets.numOfPlanet("Player2"))).thenReturn(0);
        ArrayList<Color> temp = new ArrayList<>(Arrays.asList(Color.RED));
        when(planets.choosePlanetGoods(1)).thenReturn(temp);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePlanetChoiceMessage("Player1", planets, "skip", 1);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }


    @Test
    public void handlePutBrownInShipMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        GameEventListener listener = mock(GameEventListener.class);
        when(gameModel.getGameState()).thenReturn(GameState.PLANETS);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);
        Planets planets = mock(Planets.class);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePlanetChoiceMessage("Player2", planets, "ok", 1);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn:")
        ));
    }

    @Test
    public void handlePutBrownInShipMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutBrownInShipMessage("Player1", 5,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePutBrownInShipMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutBrownInShipMessage("Player1", 5,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This message type: PUT BROWN IN SHIP is not available for this flight type:")
        ));
    }

    @Test
    public void handlePutBrownInShipMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutBrownInShipMessage("Player1", 4,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The coordinates (")
        ));
    }

    @Test
    public void handlePutBrownInShipMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutBrownInShipMessage("Player1", 5,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The coordinates (")
        ));
    }

    @Test
    public void handlePutBrownInShipMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutBrownInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The component that you have selected is not a cabin!")
        ));
    }

    @Test
    public void handlePutBrownInShipMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(2);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutBrownInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot put astronauts and aliens in the same cabine!")
        ));
    }

    @Test
    public void handlePutBrownInShipMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.isConnectedWithAlienCabine()).thenReturn(false);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutBrownInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot insert an alien in this cabin because it isn't linked to a support system!")
        ));
    }

    @Test
    public void handlePutBrownInShipMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        AlienCabine alienCabine = mock(AlienCabine.class);
        when(alienCabine.getColor()).thenReturn(Color.PURPLE);
        ArrayList<AlienCabine> cabins = new ArrayList<>();
        cabins.add(alienCabine);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.isConnectedWithAlienCabine()).thenReturn(true);
        when(cabine.getAlienCabineConnected()).thenReturn(cabins);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutBrownInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot insert a brown alien because your cabin isn't connected to a brown support system!")
        ));
    }

    @Test
    public void handlePutBrownInShipMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        AlienCabine alienCabine = mock(AlienCabine.class);
        when(alienCabine.getColor()).thenReturn(Color.YELLOW);
        ArrayList<AlienCabine> cabins = new ArrayList<>();
        cabins.add(alienCabine);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        when(cabine.isConnectedWithAlienCabine()).thenReturn(true);
        when(cabine.getAlienCabineConnected()).thenReturn(cabins);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutBrownInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot insert more crew in the cabin because there is already an alien in it!")
        ));
    }

    @Test
    public void handlePutBrownInShipMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        AlienCabine alienCabine = mock(AlienCabine.class);
        when(alienCabine.getColor()).thenReturn(Color.YELLOW);
        ArrayList<AlienCabine> cabins = new ArrayList<>();
        cabins.add(alienCabine);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(false);
        when(cabine.getHasPurpleAlien()).thenReturn(false);
        when(cabine.isConnectedWithAlienCabine()).thenReturn(true);
        when(cabine.getAlienCabineConnected()).thenReturn(cabins);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);
        when(shipBoard1.getHasBrownAlien()).thenReturn(true);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutBrownInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You ship already has a brown alien!")
        ));
    }

    @Test
    public void handlePutBrownInShipMessageTest11() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        AlienCabine alienCabine = mock(AlienCabine.class);
        when(alienCabine.getColor()).thenReturn(Color.YELLOW);
        ArrayList<AlienCabine> cabins = new ArrayList<>();
        cabins.add(alienCabine);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(false);
        when(cabine.getHasPurpleAlien()).thenReturn(false);
        when(cabine.isConnectedWithAlienCabine()).thenReturn(true);
        when(cabine.getAlienCabineConnected()).thenReturn(cabins);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);
        when(shipBoard1.getHasBrownAlien()).thenReturn(false);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutBrownInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePutBrownInShipMessageTest12() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        StartingCabine cabine = mock(StartingCabine.class);
        AlienCabine alienCabine = mock(AlienCabine.class);
        when(alienCabine.getColor()).thenReturn(Color.YELLOW);
        ArrayList<AlienCabine> cabins = new ArrayList<>();
        cabins.add(alienCabine);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);
        when(shipBoard1.getHasBrownAlien()).thenReturn(true);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutBrownInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot put aliens in the starting cabin!")
        ));
    }


    @Test
    public void handlePutPurpleInShipMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutPurpleInShipMessage("Player1", 5,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePutPurpleInShipMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutPurpleInShipMessage("Player1", 5,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This message type: PUT PURPLE IN SHIP is not available for this flight type:")
        ));
    }

    @Test
    public void handlePutPurpleInShipMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutPurpleInShipMessage("Player1", 4,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The coordinates (")
        ));
    }

    @Test
    public void handlePutPurpleInShipMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutPurpleInShipMessage("Player1", 5,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The coordinates (")
        ));
    }

    @Test
    public void handlePutPurpleInShipMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutPurpleInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The component that you have selected is not a cabin!")
        ));
    }

    @Test
    public void handlePutPurpleInShipMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(2);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutPurpleInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot put astronauts and aliens in the same cabine!")
        ));
    }

    @Test
    public void handlePutPurpleInShipMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.isConnectedWithAlienCabine()).thenReturn(false);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutPurpleInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot insert an alien in this cabin because it isn't linked to a support system!")
        ));
    }

    @Test
    public void handlePutPurpleInShipMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        AlienCabine alienCabine = mock(AlienCabine.class);
        when(alienCabine.getColor()).thenReturn(Color.YELLOW);
        ArrayList<AlienCabine> cabins = new ArrayList<>();
        cabins.add(alienCabine);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.isConnectedWithAlienCabine()).thenReturn(true);
        when(cabine.getAlienCabineConnected()).thenReturn(cabins);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutPurpleInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot insert a purple alien because your cabin isn't connected to a purple support system!")
        ));
    }

    @Test
    public void handlePutPurpleInShipMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        AlienCabine alienCabine = mock(AlienCabine.class);
        when(alienCabine.getColor()).thenReturn(Color.PURPLE);
        ArrayList<AlienCabine> cabins = new ArrayList<>();
        cabins.add(alienCabine);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        when(cabine.isConnectedWithAlienCabine()).thenReturn(true);
        when(cabine.getAlienCabineConnected()).thenReturn(cabins);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutPurpleInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot insert more crew in the cabin because there is already an alien in it!")
        ));
    }

    @Test
    public void handlePutPurpleInShipMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        AlienCabine alienCabine = mock(AlienCabine.class);
        when(alienCabine.getColor()).thenReturn(Color.PURPLE);
        ArrayList<AlienCabine> cabins = new ArrayList<>();
        cabins.add(alienCabine);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(false);
        when(cabine.getHasPurpleAlien()).thenReturn(false);
        when(cabine.isConnectedWithAlienCabine()).thenReturn(true);
        when(cabine.getAlienCabineConnected()).thenReturn(cabins);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);
        when(shipBoard1.getHasPurpleAlien()).thenReturn(true);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutPurpleInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You ship already has a purple alien!")
        ));
    }

    @Test
    public void handlePutPurpleInShipMessageTest11() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        AlienCabine alienCabine = mock(AlienCabine.class);
        when(alienCabine.getColor()).thenReturn(Color.PURPLE);
        ArrayList<AlienCabine> cabins = new ArrayList<>();
        cabins.add(alienCabine);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(false);
        when(cabine.getHasPurpleAlien()).thenReturn(false);
        when(cabine.isConnectedWithAlienCabine()).thenReturn(true);
        when(cabine.getAlienCabineConnected()).thenReturn(cabins);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);
        when(shipBoard1.getHasPurpleAlien()).thenReturn(false);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutPurpleInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePutPurpleInShipMessageTest12() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        StartingCabine cabine = mock(StartingCabine.class);
        AlienCabine alienCabine = mock(AlienCabine.class);
        when(alienCabine.getColor()).thenReturn(Color.YELLOW);
        ArrayList<AlienCabine> cabins = new ArrayList<>();
        cabins.add(alienCabine);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);
        when(shipBoard1.getHasBrownAlien()).thenReturn(true);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutPurpleInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot put aliens in the starting cabin!")
        ));
    }


    @Test
    public void handlePutFigureInShipMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 5,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePutFigureInShipMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 4,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The coordinates (")
        ));
    }

    @Test
    public void handlePutFigureInShipMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 5,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The coordinates (")
        ));
    }

    @Test
    public void handlePutFigureInShipMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The component that you have selected is not a cabine!")
        ));
    }

    @Test
    public void handlePutFigureInShipMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(2);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot insert more than two astronauts in a cabine!")
        ));
    }

    @Test
    public void handlePutFigureInShipMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePutFigureInShipMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(2);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot insert more than two astronauts in a cabine!")
        ));
    }

    @Test
    public void handlePutFigureInShipMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot insert more crew in the cabine because there is already an alien in it!")
        ));
    }

    @Test
    public void handlePutFigureInShipMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePutFigureInShipMessageTest11() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(2);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot insert more than two astronauts in a cabine!")
        ));
    }

    @Test
    public void handlePutFigureInShipMessageTest12() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handlePutFigureInShipMessageTest13() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(2);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You cannot insert more than two astronauts in a cabine!")
        ));
    }

    @Test
    public void handlePutFigureInShipMessageTest14() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.POPULATE);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutFigureInShipMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }


    @Test
    public void handlePutCardPileBackMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutCardPileBackMessage("Player1");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }


    @Test
    public void handlePutCardPileBackMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        CardPile cardPile = mock(CardPile.class);
        when(gameModel.pickCardPile(1)).thenReturn(cardPile);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(player1.getCardPileInHand()).thenReturn(null);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutCardPileBackMessage("Player1");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You can't put a card pile back because you have no card pile in hand")

        ));
    }

    @Test
    public void handlePutCardPileBackMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        CardPile cardPile = mock(CardPile.class);
        when(gameModel.pickCardPile(1)).thenReturn(cardPile);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.putCardPileBack(cardPile)).thenReturn(false);
        when(player1.getCardPileInHand()).thenReturn(cardPile);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutCardPileBackMessage("Player1");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Can't put the tile back")

        ));
    }

    @Test
    public void handlePutCardPileBackMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        CardPile cardPile = mock(CardPile.class);
        when(gameModel.pickCardPile(1)).thenReturn(cardPile);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.putCardPileBack(cardPile)).thenReturn(true);
        when(player1.getCardPileInHand()).thenReturn(cardPile);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutCardPileBackMessage("Player1");

        verify(controller).update(argThat(message ->
                message instanceof ShowTilesDeckMessage &&
                        ((ShowTilesDeckMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowTilesDeckMessage &&
                        ((ShowTilesDeckMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }


    @Test
    public void handlePutTileBackMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutTileBackMessage("Player1");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }


    @Test
    public void handlePutTileBackMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        CardPile cardPile = mock(CardPile.class);
        when(gameModel.pickCardPile(1)).thenReturn(cardPile);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(player1.getTileInHand()).thenReturn(null);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutTileBackMessage("Player1");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You can't put a tile back because you have no tile in hand")

        ));
    }

    @Test
    public void handlePutTileBackMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        Cannon cannon = mock(Cannon.class);
        when(space.getComponent()).thenReturn(cannon);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(player1.getTileInHand()).thenReturn(cannon);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getSpace(0,5)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutTileBackMessage("Player1");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You can't put the tile back because it is reserved for this ship")

        ));
    }

    @Test
    public void handlePutTileBackMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        ShipBoardSpace space1 = mock(ShipBoardSpace.class);
        Cannon cannon = mock(Cannon.class);
        when(space.getComponent()).thenReturn(cannon);
        when(space1.getComponent()).thenReturn(null);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.putTileBack(cannon)).thenReturn(false);
        when(player1.getTileInHand()).thenReturn(cannon);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getSpace(0,5)).thenReturn(space1);
        when(shipBoard1.getSpace(0,6)).thenReturn(space1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutTileBackMessage("Player1");

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Can't put the tile back")

        ));
    }

    @Test
    public void handlePutTileBackMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        ShipBoardSpace space1 = mock(ShipBoardSpace.class);
        Cannon cannon = mock(Cannon.class);
        when(space.getComponent()).thenReturn(cannon);
        when(space1.getComponent()).thenReturn(null);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.putTileBack(cannon)).thenReturn(true);
        when(player1.getTileInHand()).thenReturn(cannon);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getSpace(0,5)).thenReturn(space1);
        when(shipBoard1.getSpace(0,6)).thenReturn(space1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutTileBackMessage("Player1");

        verify(controller).update(argThat(message ->
                message instanceof ShowTilesDeckMessage &&
                        ((ShowTilesDeckMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowTilesDeckMessage &&
                        ((ShowTilesDeckMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }



    @Test
    public void handlePutTileInShipMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutTileInShipMessage("Player1",5,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }


    @Test
    public void handlePutTileInShipMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        CardPile cardPile = mock(CardPile.class);
        when(gameModel.pickCardPile(1)).thenReturn(cardPile);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(player1.getTileInHand()).thenReturn(null);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutTileInShipMessage("Player1",5,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You can't put a tile back because you have no tile in hand")

        ));
    }

    @Test
    public void handlePutTileInShipMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        Cannon cannon = mock(Cannon.class);
        when(space.getComponent()).thenReturn(cannon);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(player1.getTileInHand()).thenReturn(cannon);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getSpace(0,5)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutTileInShipMessage("Player1",4,5);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The coordinates (")

        ));
    }

    @Test
    public void handlePutTileInShipMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        Cannon cannon = mock(Cannon.class);
        when(space.getComponent()).thenReturn(cannon);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(player1.getTileInHand()).thenReturn(cannon);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getSpace(0,5)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutTileInShipMessage("Player1",5,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The coordinates (")

        ));
    }

    @Test
    public void handlePutTileInShipMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        Cannon cannon = mock(Cannon.class);
        when(space.getComponent()).thenReturn(cannon);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(player1.getTileInHand()).thenReturn(cannon);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutTileInShipMessage("Player1",5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains(") already contains a component")

        ));
    }

    @Test
    public void handlePutTileInShipMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        Cannon cannon = mock(Cannon.class);
        when(space.getComponent()).thenReturn(null);

        GameTile gameTile = mock(GameTile.class);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getGameTile()).thenReturn(gameTile);
        when(player1.getTileInHand()).thenReturn(cannon);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePutTileInShipMessage("Player1",5,4);

        verify(controller).update(argThat(message ->
                message instanceof ShowTilesDeckMessage &&
                        ((ShowTilesDeckMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowTilesDeckMessage &&
                        ((ShowTilesDeckMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }



    @Test
    public void handleRemoveBatteryMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.PLANETS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", smugglersCard,4,3, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Card not correct for this game state")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", smugglersCard,4,3, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can't be made by this player")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", smugglersCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", smugglersCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The batteries in this tile are already finished")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", smugglersCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getCardType()).thenReturn(CardName.PLANETS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", slaversCard,4,3, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Card not correct for this game state")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", slaversCard,4,3, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can't be made by this player")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", slaversCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", slaversCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The batteries in this tile are already finished")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", slaversCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PLANETS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", piratesCard,4,3, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Card not correct for this game state")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest11() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PIRATES);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", piratesCard,4,3, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can't be made by this player")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest12() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PIRATES);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", piratesCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest13() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PIRATES);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", piratesCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The batteries in this tile are already finished")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest14() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PIRATES);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", piratesCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleRemoveBatteryMessageTest15() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        OpenSpace openSpaceCard = mock(OpenSpace.class);
        when(openSpaceCard.getCardType()).thenReturn(CardName.PLANETS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", openSpaceCard,4,3, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Card not correct for this game state")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest16() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        OpenSpace openSpaceCard = mock(OpenSpace.class);
        when(openSpaceCard.getCardType()).thenReturn(CardName.OPEN_SPACE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", openSpaceCard,4,3, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can't be made by this player")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest17() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        OpenSpace openSpaceCard = mock(OpenSpace.class);
        when(openSpaceCard.getCardType()).thenReturn(CardName.OPEN_SPACE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", openSpaceCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest18() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        OpenSpace openSpaceCard = mock(OpenSpace.class);
        when(openSpaceCard.getCardType()).thenReturn(CardName.OPEN_SPACE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", openSpaceCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The batteries in this tile are already finished")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest19() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        OpenSpace openSpaceCard = mock(OpenSpace.class);
        when(openSpaceCard.getCardType()).thenReturn(CardName.OPEN_SPACE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.OPEN_SPACE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", openSpaceCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest20() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.PLANETS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", meteorSwarmCard,4,3, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Card not correct for this game state")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest21() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", meteorSwarmCard,4,3, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can't be made by this player")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest22() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", meteorSwarmCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest23() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", meteorSwarmCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The batteries in this tile are already finished")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest24() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.METEOR_SWARM);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", meteorSwarmCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }



    @Test
    public void handleRemoveBatteryMessageTest25() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,4,3, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can't be made by this player")
        ));
    }


    @Test
    public void handleRemoveBatteryMessageTest26() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getFaseCounter()).thenReturn(1);
        when(combatZoneCard.getLevel()).thenReturn(2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The batteries in this tile are already finished")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest27() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getFaseCounter()).thenReturn(1);
        when(combatZoneCard.getLevel()).thenReturn(2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest28() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getFaseCounter()).thenReturn(2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The batteries in this tile are already finished")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest29() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getFaseCounter()).thenReturn(2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest30() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getFaseCounter()).thenReturn(3);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The batteries in this tile are already finished")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest31() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getFaseCounter()).thenReturn(3);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest32() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getFaseCounter()).thenReturn(3);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.COMBAT_ZONE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        Field combatZoneFightField = Controller.class.getDeclaredField("combatZoneFight");
        combatZoneFightField.setAccessible(true);
        combatZoneFightField.set(controller, true);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest33() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", smugglersCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can't be made by this player")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest34() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", smugglersCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest35() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", smugglersCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The batteries in this tile are already finished")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest36() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard3.getNumBatteries()).thenReturn(0);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", smugglersCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest37() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard3.getNumBatteries()).thenReturn(0);
        when(player1.getPenaltyGoods()).thenReturn(1);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", smugglersCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest38() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        Player player3 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player3.getId()).thenReturn("Player3");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard3.getNumBatteries()).thenReturn(0);
        when(player1.getPenaltyGoods()).thenReturn(1);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", smugglersCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest39() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard3.getNumBatteries()).thenReturn(0);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", smugglersCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest40() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard3.getNumBatteries()).thenReturn(0);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player2", combatZoneCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("This choice can't be made by this player")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest41() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard3.getNumBatteries()).thenReturn(0);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest42() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard3.getNumBatteries()).thenReturn(0);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The batteries in this tile are already finished")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest43() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard3.getNumBatteries()).thenReturn(0);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));

        verify(controller, times(2)).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleRemoveBatteryMessageTest44() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(battery);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard3.getNumBatteries()).thenReturn(0);
        when(player1.getPenaltyGoods()).thenReturn(1);
        when(player2.getPenaltyGoods()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,5,4, 0);

        verify(controller, times(2)).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player1")
        ));
        verify(controller, times(2)).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveBatteryMessageTest45() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);


        Battery battery = mock(Battery.class);
        when(battery.getName()).thenReturn(TileName.BATTERY);
        when(battery.getNumBatteriesInUse()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_BATTERY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_BATTERIES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(shipBoard1.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard1.getNumBatteries()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard3.getNumBatteries()).thenReturn(0);
        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveBatteryMessage("Player1", combatZoneCard,5,4, 0);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }



    @Test
    public void handleRemoveFigureMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.PLANETS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_BATTERIES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", smugglersCard,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This message type: REMOVE FIGURES is not available for this game state:")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleRemoveFigureMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The cabine is empty")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasPurpleAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }




    @Test
    public void handleRemoveFigureMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasPurpleAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleRemoveFigureMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }




    @Test
    public void handleRemoveFigureMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The cabine is empty")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest11() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The cabine is empty")
        ));
    }




    @Test
    public void handleRemoveFigureMessageTest12() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest13() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.ABANDONED_SHIP);
        FlightBoard flightBoard = mock(FlightBoard.class);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleRemoveFigureMessageTest14() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest15() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest16() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(1);
        when(shipBoard1.getHasBrownAlien()).thenReturn(false);
        when(shipBoard1.getHasBrownAlien()).thenReturn(false);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest17() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(0);
        when(shipBoard1.getHasBrownAlien()).thenReturn(false);
        when(shipBoard1.getHasBrownAlien()).thenReturn(false);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleRemoveFigureMessageTest18() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The cabine is empty")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest19() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasPurpleAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(1);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }




    @Test
    public void handleRemoveFigureMessageTest20() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasPurpleAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleRemoveFigureMessageTest21() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);


        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(1);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }




    @Test
    public void handleRemoveFigureMessageTest22() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(1);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest23() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The cabine is empty")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest24() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(1);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The cabine is empty")
        ));
    }




    @Test
    public void handleRemoveFigureMessageTest25() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(1);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest26() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(1);
        when(shipBoard1.getNumFigures()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest27() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(1);

        when(player1.getPenaltyEquipment()).thenReturn(0);
        when(player2.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);
    }

    @Test
    public void handleRemoveFigureMessageTest28() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SLAVERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasPurpleAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(1);

        when(player1.getPenaltyEquipment()).thenReturn(0);
        when(player2.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);
    }


    @Test
    public void handleRemoveFigureMessageTest29() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_BATTERIES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", smugglersCard,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This message type: REMOVE FIGURES is not available for this game state:")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest30() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest31() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest32() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest33() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleRemoveFigureMessageTest34() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The cabine is empty")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest35() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasPurpleAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }




    @Test
    public void handleRemoveFigureMessageTest36() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasPurpleAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleRemoveFigureMessageTest37() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }




    @Test
    public void handleRemoveFigureMessageTest38() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest39() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cabine cabine = mock(Cabine.class);
        when(cabine.getName()).thenReturn(TileName.CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        when(cabine.getHasBrownAlien()).thenReturn(true);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The cabine is empty")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest40() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(0);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The cabine is empty")
        ));
    }




    @Test
    public void handleRemoveFigureMessageTest41() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveFigureMessageTest42() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        StartingCabine cabine = mock(StartingCabine.class);
        when(cabine.getName()).thenReturn(TileName.STARTING_CABINE);
        when(cabine.getNumFigures()).thenReturn(1);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cabine);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_FIGURE);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_FIGURES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveFigureMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
    }






    @Test
    public void handleRemoveGoodMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.PLANETS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_BATTERIES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", smugglersCard,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This message type: REMOVE GOODS is not available for this game state:")
        ));
    }

    @Test
    public void handleRemoveGoodMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", abandonedShip,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn")
        ));
    }

    @Test
    public void handleRemoveGoodMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cargo cargo = mock(Cargo.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }

    @Test
    public void handleRemoveGoodMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.rarestCargoIn()).thenReturn(null);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains(") doesn't contain the rarest goods block in the ship")
        ));
    }

    @Test
    public void handleRemoveGoodMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.rarestCargoIn()).thenReturn(Color.RED);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(Color.RED);

        when(player1.getPenaltyGoods()).thenReturn(1);
        when(player2.getPenaltyGoods()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveGoodMessage &&
                        ((AskRemoveGoodMessage) message).getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleRemoveGoodMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.rarestCargoIn()).thenReturn(Color.RED);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(Color.RED).thenReturn(null);

        when(player1.getPenaltyGoods()).thenReturn(1);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getNumBatteries()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", abandonedShip,5,4);

        verify(controller, times(2)).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveGoodMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.SMUGGLERS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.rarestCargoIn()).thenReturn(Color.RED);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(Color.RED).thenReturn(null);

        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRemoveGoodMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", abandonedShip,4,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn")
        ));
    }

    @Test
    public void handleRemoveGoodMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cargo cargo = mock(Cargo.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("The tile in coordinates (")
        ));
    }

    @Test
    public void handleRemoveGoodMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.rarestCargoIn()).thenReturn(null);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        when(player1.getPenaltyEquipment()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains(") doesn't contain the rarest goods block in the ship")
        ));
    }

    @Test
    public void handleRemoveGoodMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.rarestCargoIn()).thenReturn(Color.RED);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(Color.RED);

        when(player1.getPenaltyGoods()).thenReturn(1);
        when(player2.getPenaltyGoods()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveGoodMessage &&
                        ((AskRemoveGoodMessage) message).getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleRemoveGoodMessageTest11() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.rarestCargoIn()).thenReturn(Color.RED);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(Color.RED);

        when(player1.getPenaltyGoods()).thenReturn(0);
        when(player2.getPenaltyGoods()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller, times(2)).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextPhaseMessage &&
                        ((ProceedNextPhaseMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRemoveGoodMessageTest12() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Cargo cargo = mock(Cargo.class);
        when(cargo.getName()).thenReturn(TileName.CARGO);
        when(cargo.rarestCargoIn()).thenReturn(Color.RED);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cargo);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(Color.RED).thenReturn(null);

        when(player1.getPenaltyGoods()).thenReturn(1);
        when(player2.getPenaltyGoods()).thenReturn(0);
        when(shipBoard2.rarestGoodsBlock()).thenReturn(null);
        when(shipBoard2.getNumBatteries()).thenReturn(0);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveGoodMessage("Player1", abandonedShip,5,4);

        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player1")
        ));

    }






    @Test
    public void handleRemoveTileMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);

        //when(controller.getGameModel()).thenReturn(gameModel);

        Cannon cannon = mock(Cannon.class);
        when(gameModel.pickTile(1)).thenReturn(cannon);
        when(player1.getTileInHand()).thenReturn(null);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveTileMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This message type: PICK UP TILE is not available for this game state:")
        ));
    }

    @Test
    public void handleRemoveTileMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getGameState()).thenReturn(GameState.FIXING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);

        //when(controller.getGameModel()).thenReturn(gameModel);

        Cannon cannon = mock(Cannon.class);
        when(gameModel.pickTile(1)).thenReturn(cannon);
        when(player1.getTileInHand()).thenReturn(null);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveTileMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Player not in turn")
        ));
    }

    @Test
    public void handleRemoveTileMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(player1.getPlayerState()).thenReturn(PlayerState.FIX);

        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getGameState()).thenReturn(GameState.FIXING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);

        //when(controller.getGameModel()).thenReturn(gameModel);

        Cannon cannon = mock(Cannon.class);
        when(gameModel.pickTile(1)).thenReturn(cannon);
        when(player1.getTileInHand()).thenReturn(null);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveTileMessage("Player1", 3,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Wrong space")
        ));
    }

    @Test
    public void handleRemoveTileMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(player1.getPlayerState()).thenReturn(PlayerState.FIX);

        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getGameState()).thenReturn(GameState.FIXING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);

        //when(controller.getGameModel()).thenReturn(gameModel);

        Cannon cannon = mock(Cannon.class);
        when(gameModel.pickTile(1)).thenReturn(cannon);
        when(player1.getTileInHand()).thenReturn(null);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveTileMessage("Player1", 5,3);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Wrong space")
        ));
    }

    @Test
    public void handleRemoveTileMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");


        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(player1.getPlayerState()).thenReturn(PlayerState.FIX);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getGameState()).thenReturn(GameState.FIXING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        //when(controller.getGameModel()).thenReturn(gameModel);

        Cannon cannon = mock(Cannon.class);
        when(gameModel.pickTile(1)).thenReturn(cannon);
        when(player1.getTileInHand()).thenReturn(null);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveTileMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("Cannot remove a component from an empty space")
        ));
    }

    @Test
    public void handleRemoveTileMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);

        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");


        Cannon cannon = mock(Cannon.class);
        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(cannon);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        FlightBoard flightBoard = mock(FlightBoard.class);

        when(player1.getPlayerState()).thenReturn(PlayerState.REPAIR);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(players);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);

        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        //when(controller.getGameModel()).thenReturn(gameModel);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRemoveTileMessage("Player1", 5,4);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        message.getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleRepairingShipMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.METEOR_SWARM);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRepairingShipMessage("Player1", abandonedShip);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This message type: REPAIRING SHIP is not available for this game state:")
        ));
    }

    @Test
    public void handleRepairingShipMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.METEOR_SWARM);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.WAIT);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRepairingShipMessage("Player1", abandonedShip);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("You are not in turn")
        ));
    }


    @Test
    public void handleRepairingShipMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        AbandonedShip abandonedShip = mock(AbandonedShip.class);
        when(abandonedShip.getCardType()).thenReturn(CardName.METEOR_SWARM);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REPAIR);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(player2.getHasFinishedBuilding()).thenReturn(false);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRepairingShipMessage("Player1", abandonedShip);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("Waiting for other players to finish repairing their ships.")
        ));
    }


    @Test
    public void handleRepairingShipMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REPAIR);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRepairingShipMessage("Player1", meteorSwarmCard);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRepairingShipMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        when(meteorSwarmCard.getCounter()).thenReturn(2);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REPAIR);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRepairingShipMessage("Player1", meteorSwarmCard);

        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        message.getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleRepairingShipMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException, MultipleValidationErrorsException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        when(meteorSwarmCard.getCounter()).thenReturn(2);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REPAIR);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(true);
        when(shipBoard1.getCorrectShip()).thenReturn(false);
        when(shipBoard2.getCorrectShip()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        ArrayList<String> exceptions = new ArrayList<>(Arrays.asList("exc1", "exc2", "exc3"));
        doThrow(new MultipleValidationErrorsException(exceptions)).when(shipBoard1).validateShipBoard();

        controller.handleRepairingShipMessage("Player1", meteorSwarmCard);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipErrorsMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player2") &&
                        ((GenericMessage2)message).getMessage().contains("Your ship board is correct, but there are other players that need to fix their ship. You have to wait the other players...")
        ));
    }


    @Test
    public void handleRepairingShipMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getCounter()).thenReturn(1);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REPAIR);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRepairingShipMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRepairingShipMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getCounter()).thenReturn(2);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REPAIR);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRepairingShipMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        message.getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleRepairingShipMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException, MultipleValidationErrorsException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getCounter()).thenReturn(1);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REPAIR);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(true);
        when(shipBoard1.getCorrectShip()).thenReturn(false);
        when(shipBoard2.getCorrectShip()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        ArrayList<String> exceptions = new ArrayList<>(Arrays.asList("exc1", "exc2", "exc3"));
        doThrow(new MultipleValidationErrorsException(exceptions)).when(shipBoard1).validateShipBoard();

        controller.handleRepairingShipMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipErrorsMessage &&
                        message.getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRepairingShipMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException, MultipleValidationErrorsException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getCounter()).thenReturn(1);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REPAIR);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(true);
        when(shipBoard1.getCorrectShip()).thenReturn(true);
        when(shipBoard2.getCorrectShip()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        ArrayList<String> exceptions = new ArrayList<>(Arrays.asList("exc1", "exc2", "exc3"));
        doThrow(new MultipleValidationErrorsException(exceptions)).when(shipBoard1).validateShipBoard();

        controller.handleRepairingShipMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipErrorsMessage &&
                        message.getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRepairingShipMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PIRATES);
        when(piratesCard.getCounter()).thenReturn(1);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Integer> shots = new ArrayList<>();
        shots.add(1);
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REPAIR);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRepairingShipMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRepairingShipMessageTest11() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PIRATES);
        when(piratesCard.getCounter()).thenReturn(2);
        ArrayList<Integer> shots = new ArrayList<>();
        shots.add(1);
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REPAIR);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRepairingShipMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        message.getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleRepairingShipMessageTest12() throws IOException, NoSuchFieldException, IllegalAccessException, MultipleValidationErrorsException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PIRATES);
        when(piratesCard.getCounter()).thenReturn(2);
        ArrayList<Integer> shots = new ArrayList<>();
        shots.add(1);
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REPAIR);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REPAIRING);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        when(player1.getHasFinishedBuilding()).thenReturn(true);
        when(player2.getHasFinishedBuilding()).thenReturn(true);
        when(shipBoard1.getCorrectShip()).thenReturn(false);
        when(shipBoard2.getCorrectShip()).thenReturn(true);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        ArrayList<String> exceptions = new ArrayList<>(Arrays.asList("exc1", "exc2", "exc3"));
        doThrow(new MultipleValidationErrorsException(exceptions)).when(shipBoard1).validateShipBoard();

        controller.handleRepairingShipMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof ShowShipErrorsMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player2") &&
                        ((GenericMessage2)message).getMessage().contains("Your ship board is correct, but there are other players that need to fix their ship. You have to wait the other players...")
        ));
    }


    @Test
    public void handleRetireMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player1);
        retiredPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRetireMessage("Player1", gameEventListener);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }

    @Test
    public void handleRetireMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRetireMessage("Player1", gameEventListener);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }

    @Test
    public void handleRetireMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRetireMessage("Player1", gameEventListener);

        verify(controller,times(2)).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }

    @Test
    public void handleRetireMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumFigures()).thenReturn(0);
        when(shipBoard2.getNumFigures()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRetireMessage("Player1", gameEventListener);

        verify(controller,times(3)).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }

    @Test
    public void handleRetireMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Couple couple1 = mock(Couple.class);
        Couple couple2 = mock(Couple.class);
        when(couple1.getFirst()).thenReturn(1);
        when(couple1.getSecond()).thenReturn(1);
        when(couple2.getFirst()).thenReturn(2);
        when(couple2.getSecond()).thenReturn(2);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumFigures()).thenReturn(0);
        when(shipBoard2.getNumFigures()).thenReturn(1);

        when(flightBoard.getPlayerPosition(player1)).thenReturn(couple1);
        when(flightBoard.getPlayerPosition(player2)).thenReturn(couple2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRetireMessage("Player1", gameEventListener);

        verify(controller,times(4)).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }

    @Test
    public void handleRetireMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Couple couple1 = mock(Couple.class);
        Couple couple2 = mock(Couple.class);
        when(couple1.getFirst()).thenReturn(1);
        when(couple1.getSecond()).thenReturn(1);
        when(couple2.getFirst()).thenReturn(2);
        when(couple2.getSecond()).thenReturn(2);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        ArrayList<Card> cards = new ArrayList<>();

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getCardsToPlay()).thenReturn(cards);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumFigures()).thenReturn(0);
        when(shipBoard2.getNumFigures()).thenReturn(1);

        when(flightBoard.getPlayerPosition(player1)).thenReturn(couple1);
        when(flightBoard.getPlayerPosition(player2)).thenReturn(couple2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRetireMessage("Player1", gameEventListener);

        verify(controller,times(2)).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }

    @Test
    public void handleRetireMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Couple couple1 = mock(Couple.class);
        Couple couple2 = mock(Couple.class);
        when(couple1.getFirst()).thenReturn(1);
        when(couple1.getSecond()).thenReturn(1);
        when(couple2.getFirst()).thenReturn(2);
        when(couple2.getSecond()).thenReturn(2);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        ArrayList<Card> cards = new ArrayList<>();
        Planets planets = mock(Planets.class);
        cards.add(planets);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getCardsToPlay()).thenReturn(cards);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumFigures()).thenReturn(0);
        when(shipBoard2.getNumFigures()).thenReturn(1);

        when(flightBoard.getPlayerPosition(player1)).thenReturn(couple1);
        when(flightBoard.getPlayerPosition(player2)).thenReturn(couple2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRetireMessage("Player1", gameEventListener);

        verify(controller,times(2)).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }

    @Test
    public void handleRetireMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        ArrayList<Card> cards = new ArrayList<>();
        Planets planets = mock(Planets.class);
        cards.add(planets);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getCardsToPlay()).thenReturn(cards);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumFigures()).thenReturn(0);
        when(shipBoard2.getNumFigures()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRetireMessage("Player1", gameEventListener);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }



    @Test
    public void handleWaitProceedMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleWaitProceedMessage("Player1", gameEventListener);

        verify(controller).update(argThat(message ->
                message instanceof NotProceedMessage &&
                        message.getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleWaitProceedMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleWaitProceedMessage("Player1", gameEventListener);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }

    @Test
    public void handleWaitProceedMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumFigures()).thenReturn(0);
        when(shipBoard2.getNumFigures()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleWaitProceedMessage("Player1", gameEventListener);

        verify(controller,times(2)).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }

    @Test
    public void handleWaitProceedMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Couple couple1 = mock(Couple.class);
        Couple couple2 = mock(Couple.class);
        when(couple1.getFirst()).thenReturn(1);
        when(couple1.getSecond()).thenReturn(1);
        when(couple2.getFirst()).thenReturn(2);
        when(couple2.getSecond()).thenReturn(2);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumFigures()).thenReturn(0);
        when(shipBoard2.getNumFigures()).thenReturn(1);

        when(flightBoard.getPlayerPosition(player1)).thenReturn(couple1);
        when(flightBoard.getPlayerPosition(player2)).thenReturn(couple2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleWaitProceedMessage("Player1", gameEventListener);

        verify(controller,times(3)).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }

    @Test
    public void handleWaitProceedMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Couple couple1 = mock(Couple.class);
        Couple couple2 = mock(Couple.class);
        when(couple1.getFirst()).thenReturn(1);
        when(couple1.getSecond()).thenReturn(1);
        when(couple2.getFirst()).thenReturn(2);
        when(couple2.getSecond()).thenReturn(2);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        ArrayList<Card> cards = new ArrayList<>();

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getCardsToPlay()).thenReturn(cards);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumFigures()).thenReturn(0);
        when(shipBoard2.getNumFigures()).thenReturn(1);

        when(flightBoard.getPlayerPosition(player1)).thenReturn(couple1);
        when(flightBoard.getPlayerPosition(player2)).thenReturn(couple2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleWaitProceedMessage("Player1", gameEventListener);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }

    @Test
    public void handleWaitProceedMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);
        Couple couple1 = mock(Couple.class);
        Couple couple2 = mock(Couple.class);
        when(couple1.getFirst()).thenReturn(1);
        when(couple1.getSecond()).thenReturn(1);
        when(couple2.getFirst()).thenReturn(2);
        when(couple2.getSecond()).thenReturn(2);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        ArrayList<Card> cards = new ArrayList<>();
        Planets planets = mock(Planets.class);
        cards.add(planets);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getCardsToPlay()).thenReturn(cards);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumFigures()).thenReturn(0);
        when(shipBoard2.getNumFigures()).thenReturn(1);

        when(flightBoard.getPlayerPosition(player1)).thenReturn(couple1);
        when(flightBoard.getPlayerPosition(player2)).thenReturn(couple2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleWaitProceedMessage("Player1", gameEventListener);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        message.getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("You are not in the flight anymore. Watch the other player!!")
        ));
    }

    @Test
    public void handleWaitProceedMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        GameEventListener gameEventListener = mock(GameEventListener.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        ArrayList<Card> cards = new ArrayList<>();
        Planets planets = mock(Planets.class);
        cards.add(planets);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_GOODS);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getCardsToPlay()).thenReturn(cards);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers).thenReturn(retiredPlayers).
                thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumFigures()).thenReturn(0);
        when(shipBoard2.getNumFigures()).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleWaitProceedMessage("Player1", gameEventListener);
    }






    @Test
    public void handleRollDiceMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getCardType()).thenReturn(CardName.PLANETS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.REMOVE_BATTERIES);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", smugglersCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This message type: ROLL_DICE is not available for this game state:")
        ));
    }

    @Test
    public void handleRollDiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        when(meteorSwarmCard.getCounter()).thenReturn(2);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player2", meteorSwarmCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn")
        ));
    }

    @Test
    public void handleRollDiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        when(meteorSwarmCard.getCounter()).thenReturn(2);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(0, 0);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", meteorSwarmCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player2") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRollDiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(0, 0);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", meteorSwarmCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player2") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRollDiceMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        Meteor meteor = mock(Meteor.class);
        when(meteor.getDirection()).thenReturn("nord");
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        meteors.add(meteor);
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(0, 0);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", meteorSwarmCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player2") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRollDiceMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getDirection()).thenReturn("est");
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(0, 0);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", meteorSwarmCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player2") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleRollDiceMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        MeteorSwarm meteorSwarmCard = mock(MeteorSwarm.class);
        when(meteorSwarmCard.getCardType()).thenReturn(CardName.METEOR_SWARM);
        when(meteorSwarmCard.getCounter()).thenReturn(1);
        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getDirection()).thenReturn("est");
        when(meteorSwarmCard.getMeteor()).thenReturn(meteors);
        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(2, 5);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", meteorSwarmCard);

        verify(controller).update(argThat(message ->
                message instanceof MeteorHitMessage &&
                        ((MeteorHitMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof MeteorHitMessage &&
                        ((MeteorHitMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRollDiceMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);

        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteor.getDirection()).thenReturn("nord");
        when(combatZoneCard.getCounter()).thenReturn(1);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player2", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn")
        ));
    }

    @Test
    public void handleRollDiceMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);

        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteor.getDirection()).thenReturn("nord");
        when(combatZoneCard.getCounter()).thenReturn(1);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(0, 0);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRollDiceMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);

        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteor.getDirection()).thenReturn("nord");
        when(combatZoneCard.getCounter()).thenReturn(1);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(0, 0);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRollDiceMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);

        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteor.getDirection()).thenReturn("nord");
        when(combatZoneCard.getCounter()).thenReturn(1);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(0, 0);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRollDiceMessageTest11() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);

        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteor.getDirection()).thenReturn("nord");
        when(combatZoneCard.getCounter()).thenReturn(1);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(0, 0);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleRollDiceMessageTest12() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);

        Meteor meteor = mock(Meteor.class);
        ArrayList<Meteor> meteors = new ArrayList<>();
        meteors.add(meteor);
        meteors.add(meteor);
        when(meteor.getPower()).thenReturn(1);
        when(meteor.getDirection()).thenReturn("nord");
        when(combatZoneCard.getCounter()).thenReturn(1);

        Object[] faseThree = new Object[3];
        faseThree[2] = meteors;
        when(combatZoneCard.getFaseThree()).thenReturn(faseThree);

        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(2, 5);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof MeteorHitMessage &&
                        ((MeteorHitMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleRollDiceMessageTest13() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PIRATES);
        ArrayList<Integer> shots = new ArrayList<>();
        shots.add(1);
        when(piratesCard.getCounter()).thenReturn(1);
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.PLAY);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateCannon(3,4)).thenReturn(1);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player2", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn")
        ));
    }

    @Test
    public void handleRollDiceMessageTest14() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PIRATES);
        ArrayList<Integer> shots = new ArrayList<>();
        shots.add(1);
        shots.add(1);
        when(piratesCard.getCounter()).thenReturn(1);
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(0, 0);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player2") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        ((AskRollDiceMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRollDiceMessageTest15() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PIRATES);
        ArrayList<Integer> shots = new ArrayList<>();
        shots.add(1);
        when(piratesCard.getCounter()).thenReturn(1);
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(0, 0);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player1") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GenericMessage2 &&
                        ((GenericMessage2) message).getClientId().equals("Player2") &&
                        ((GenericMessage2) message).getMessage().contains("The dice rolled returned ")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleRollDiceMessageTest16() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PIRATES);
        ArrayList<Integer> shots = new ArrayList<>();
        shots.add(1);
        shots.add(1);
        when(piratesCard.getCounter()).thenReturn(1);
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(2, 5);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleRollDiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof MeteorHitMessage &&
                        ((MeteorHitMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof MeteorHitMessage &&
                        ((MeteorHitMessage) message).getClientId().equals("Player2")
        ));
    }


    @Test
    public void handleShowAllShipBoardsMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Pirates piratesCard = mock(Pirates.class);
        when(piratesCard.getCardType()).thenReturn(CardName.PIRATES);
        ArrayList<Integer> shots = new ArrayList<>();
        shots.add(1);
        shots.add(1);
        when(piratesCard.getCounter()).thenReturn(1);
        when(piratesCard.getShotsPowerArray()).thenReturn(shots);

        FlightBoard flightBoard = mock(FlightBoard.class);

        ShipBoardSpace space = mock(ShipBoardSpace.class);
        when(space.getComponent()).thenReturn(null);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);

        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.ROLL_DICE);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.getSpace(0,0)).thenReturn(space);

        Random mockedRandom = mock(Random.class);
        when(mockedRandom.nextInt(6)).thenReturn(2, 5);
        Field randomField = Controller.class.getDeclaredField("random");
        randomField.setAccessible(true);
        randomField.set(controller, mockedRandom);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleShowAllShipBoardsMessage("Player1");

        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
    }





    @Test
    public void handleSlaversChoiceMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Pirates piratesCard = mock(Pirates.class);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSlaversChoiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleSlaversChoiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        GameEventListener listener = mock(GameEventListener.class);
        when(gameModel.getGameState()).thenReturn(GameState.PIRATES);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);
        Pirates piratesCard = mock(Pirates.class);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handlePiratesChoiceMessage("Player2", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn:")
        ));
    }

    @Test
    public void handleSlaversChoiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSlaversChoiceMessage("Player2", slaversCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("This choice can be made only by the player in turn: ")
        ));
    }

    @Test
    public void handleSlaversChoiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard2.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(1);
        when(player2.getPenaltyEquipment()).thenReturn(0);
        when(player3.getPenaltyEquipment()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSlaversChoiceMessage("Player1", slaversCard);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller,times(2)).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleSlaversChoiceMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard2.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(0);
        when(player2.getPenaltyEquipment()).thenReturn(0);
        when(player3.getPenaltyEquipment()).thenReturn(0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSlaversChoiceMessage("Player1", slaversCard);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller,times(2)).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player3")
        ));
    }


    @Test
    public void handleSlaversChoiceMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(1.0);

        when(shipBoard2.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(0);
        when(player2.getPenaltyEquipment()).thenReturn(0);
        when(player3.getPenaltyEquipment()).thenReturn(0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSlaversChoiceMessage("Player1", slaversCard);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
    }


    @Test
    public void handleSlaversChoiceMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(1.0);

        when(shipBoard2.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(1);
        when(player2.getPenaltyEquipment()).thenReturn(0);
        when(player3.getPenaltyEquipment()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSlaversChoiceMessage("Player1", slaversCard);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller,times(2)).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleSlaversChoiceMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(1.0);

        when(shipBoard2.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(0);
        when(player2.getPenaltyEquipment()).thenReturn(0);
        when(player3.getPenaltyEquipment()).thenReturn(0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSlaversChoiceMessage("Player1", slaversCard);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller,times(2)).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleSlaversChoiceMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(0.5);

        when(shipBoard2.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(1);
        when(player2.getPenaltyEquipment()).thenReturn(0);
        when(player3.getPenaltyEquipment()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSlaversChoiceMessage("Player1", slaversCard);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller,times(2)).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveFigureMessage &&
                        ((AskRemoveFigureMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleSlaversChoiceMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(0.5);

        when(shipBoard2.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(0);
        when(player2.getPenaltyEquipment()).thenReturn(0);
        when(player3.getPenaltyEquipment()).thenReturn(0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSlaversChoiceMessage("Player1", slaversCard);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller,times(2)).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        ((ShowShipBoardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ReturnAllShipBoardsMessage &&
                        ((ReturnAllShipBoardsMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleSlaversChoiceMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Slavers slaversCard = mock(Slavers.class);
        when(slaversCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.SLAVERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(0.5);

        when(shipBoard2.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(0);
        when(player2.getPenaltyEquipment()).thenReturn(0);
        when(player3.getPenaltyEquipment()).thenReturn(0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSlaversChoiceMessage("Player1", slaversCard);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
    }



    @Test
    public void handleSmugglersChoiceMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player2", "Player2", Color.RED, FlightType.STANDARD_FLIGHT);
        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);

        Pirates piratesCard = mock(Pirates.class);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSmugglersChoiceMessage("Player1", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("not available for this game state") &&
                        ((GenericErrorMessage) message).getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleSmugglersChoiceMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Player player1 = new Player("Player1", "Player1", Color.RED, FlightType.STANDARD_FLIGHT);
        GameEventListener listener = mock(GameEventListener.class);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getMaxPlayers()).thenReturn(2);
        //when(controller.getGameModel()).thenReturn(gameModel);
        Pirates piratesCard = mock(Pirates.class);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSmugglersChoiceMessage("Player2", piratesCard);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        ((GenericErrorMessage) message).getClientId().equals("Player2") &&
                        ((GenericErrorMessage) message).getErrorMessage().contains("This choice can be made only by the player in turn:")
        ));
    }


    @Test
    public void handleSmugglersChoiceMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(2.0);

        when(shipBoard2.getNumFigures()).thenReturn(2);
        ArrayList<Color> goods = new ArrayList<>();
        goods.add(Color.RED);
        when(smugglersCard.getColorOfGoodsTaken()).thenReturn(goods);

        when(player1.getPenaltyEquipment()).thenReturn(1);
        when(player2.getPenaltyEquipment()).thenReturn(0);
        when(player3.getPenaltyEquipment()).thenReturn(1);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSmugglersChoiceMessage("Player1", smugglersCard);

        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof UpdateParametresMessage &&
                        ((UpdateParametresMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof GainedGoodsMessage &&
                        ((GainedGoodsMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof WaitMessage &&
                        ((WaitMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof WaitMessage &&
                        ((WaitMessage) message).getClientId().equals("Player3")
        ));
    }


    @Test
    public void handleSmugglersChoiceMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(1.0);

        when(shipBoard2.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(0);
        when(player2.getPenaltyEquipment()).thenReturn(0);
        when(player3.getPenaltyEquipment()).thenReturn(0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSmugglersChoiceMessage("Player1", smugglersCard);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
    }


    @Test
    public void handleSmugglersChoiceMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(1.0);

        when(shipBoard3.getNumBatteries()).thenReturn(2);

        when(player1.getPenaltyGoods()).thenReturn(1);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(Color.RED);
        when(player2.getPenaltyGoods()).thenReturn(0);
        when(player3.getPenaltyGoods()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSmugglersChoiceMessage("Player1", smugglersCard);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveGoodMessage &&
                        ((AskRemoveGoodMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleSmugglersChoiceMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(1.0);

        when(shipBoard3.getNumBatteries()).thenReturn(2);

        when(player1.getPenaltyGoods()).thenReturn(1);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(Color.RED);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSmugglersChoiceMessage("Player1", smugglersCard);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveGoodMessage &&
                        ((AskRemoveGoodMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleSmugglersChoiceMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(1.0);

        when(shipBoard3.getNumBatteries()).thenReturn(2);

        when(player1.getPenaltyGoods()).thenReturn(0);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(Color.RED);
        when(player2.getPenaltyGoods()).thenReturn(0);
        when(player3.getPenaltyGoods()).thenReturn(0);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSmugglersChoiceMessage("Player1", smugglersCard);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleSmugglersChoiceMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player2);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(0.5);

        when(shipBoard2.getNumFigures()).thenReturn(2);

        when(player1.getPenaltyEquipment()).thenReturn(0);
        when(player2.getPenaltyEquipment()).thenReturn(0);
        when(player3.getPenaltyEquipment()).thenReturn(0);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSmugglersChoiceMessage("Player1", smugglersCard);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        ((SetCardInUseMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player3")
        ));
    }


    @Test
    public void handleSmugglersChoiceMessageTest8() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(0.5);

        when(shipBoard3.getNumBatteries()).thenReturn(2);

        when(player1.getPenaltyGoods()).thenReturn(1);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(Color.RED);
        when(player2.getPenaltyGoods()).thenReturn(0);
        when(player3.getPenaltyGoods()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSmugglersChoiceMessage("Player1", smugglersCard);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveGoodMessage &&
                        ((AskRemoveGoodMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        ((DrawnCardMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleSmugglersChoiceMessageTest9() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(0.5);

        when(shipBoard3.getNumBatteries()).thenReturn(2);

        when(player1.getPenaltyGoods()).thenReturn(1);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(Color.RED);
        when(player2.getPenaltyGoods()).thenReturn(1);
        when(player3.getPenaltyGoods()).thenReturn(1);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSmugglersChoiceMessage("Player1", smugglersCard);

        verify(controller).update(argThat(message ->
                message instanceof AskRemoveGoodMessage &&
                        ((AskRemoveGoodMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRemoveBatteryMessage &&
                        ((AskRemoveBatteryMessage) message).getClientId().equals("Player3")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        ((ChangeTuiStateMessage) message).getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleSmugglersChoiceMessageTest10() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        Smugglers smugglersCard = mock(Smugglers.class);
        when(smugglersCard.getEnemyStrength()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        Player player2 = mock(Player.class);
        when(player2.getId()).thenReturn("Player2");
        Player player3 = mock(Player.class);
        when(player3.getId()).thenReturn("Player3");
        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> defeatedPlayers = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        players.add(player3);
        playersPositions.add(player1);
        playersPositions.add(player2);
        playersPositions.add(player3);
        defeatedPlayers.add(player1);
        defeatedPlayers.add(player2);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getNextPlayer()).thenReturn(player1);
        when(gameModel.getGameState()).thenReturn(GameState.SMUGGLERS);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getDefeatedPlayers()).thenReturn(defeatedPlayers);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        ShipBoard shipBoard3 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);
        when(player3.getShipBoard()).thenReturn(shipBoard3);
        when(shipBoard1.getNumBatteries()).thenReturn(1);
        when(shipBoard1.activateShield(3,4)).thenReturn(1);
        when(shipBoard1.calculateFireStrength()).thenReturn(0.5);

        when(shipBoard3.getNumBatteries()).thenReturn(2);

        when(player1.getPenaltyGoods()).thenReturn(0);
        when(shipBoard1.rarestGoodsBlock()).thenReturn(Color.RED);
        when(player2.getPenaltyGoods()).thenReturn(0);
        when(player3.getPenaltyGoods()).thenReturn(0);
        when(shipBoard3.rarestGoodsBlock()).thenReturn(null);


        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleSmugglersChoiceMessage("Player1", smugglersCard);

        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        ((ProceedNextCardMessage) message).getClientId().equals("Player3")
        ));
    }

    @Test
    public void handleStopWatchingShipsMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleStopWatchingShipsMessage("Player1", planets);

        verify(controller).update(argThat(message ->
                message instanceof ShowTilesDeckMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowTilesDeckMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ShowShipBoardMessage &&
                        message.getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleStopWatchingShipsMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleStopWatchingShipsMessage("Player1", planets);

        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        message.getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleStopWatchingShipsMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getPlayerInTurn()).thenReturn(player2);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleStopWatchingShipsMessage("Player1", planets);

        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        message.getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleStopWatchingShipsMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.PLANETS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleStopWatchingShipsMessage("Player1", planets);

        verify(controller).update(argThat(message ->
                message instanceof ChangeTuiStateMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        message.getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleStopWatchingShipsMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        when(planets.getCardType()).thenReturn(CardName.PLANETS);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player1);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);

        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleStopWatchingShipsMessage("Player1", planets);

        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage2 &&
                        message.getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleTimerMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleTimerMessage("Player1", 10);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("This message type: TIMER is not available for this game state:")
        ));

    }

    @Test
    public void handleTimerMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleTimerMessage("Player1", 10);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("This message type: TIMER is not available for this flight type:")
        ));
    }


    @Test
    public void handleTimerMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getTimerPosition()).thenReturn(0);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleTimerMessage("Player1", 10);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("It's not possible to flip the timer anymore")
        ));
    }

    @Test
    public void handleTimerMessageTest3() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getTimerPosition()).thenReturn(1);
        when(gameModel.activateTimer()).thenReturn(false);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleTimerMessage("Player1", 10);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The time of the previous flip is not finished. You have to wait before flip the timer again")
        ));
    }

    @Test
    public void handleTimerMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getTimerPosition()).thenReturn(1);
        when(gameModel.activateTimer()).thenReturn(false);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleTimerMessage("Player1", 10);

        verify(controller).update(argThat(message ->
                message instanceof GenericErrorMessage &&
                        message.getClientId().equals("Player1") &&
                        ((GenericErrorMessage)message).getErrorMessage().contains("The time of the previous flip is not finished. You have to wait before flip the timer again")
        ));
    }

    @Test
    public void handleTimerMessageTest5() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getTimerPosition()).thenReturn(1);
        when(gameModel.activateTimer()).thenReturn(true);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleTimerMessage("Player1", 10);
    }

    @Test
    public void handleTimerMessageTest6() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getTimerPosition()).thenReturn(1);
        when(gameModel.activateTimer()).thenReturn(true);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleTimerMessage("Player1", 0);
    }

    @Test
    public void handleTimerMessageTest7() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        Planets planets = mock(Planets.class);
        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);
        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.BUILDING);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getTimerPosition()).thenReturn(2);
        when(gameModel.activateTimer()).thenReturn(true);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleTimerMessage("Player1", 0);
    }

    @Test
    public void handleUserNameMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        controller.handleUsernameMessage("Player1", "Player1");
    }

    @Test
    public void handleWaitNextPhaseMessageTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(false);

        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers).thenReturn(retiredPlayers1);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleWaitNextPhaseMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof NotProceedMessage &&
                        message.getClientId().equals("Player1")
        ));
    }

    @Test
    public void handleWaitNextPhaseMessageTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getFaseCounter()).thenReturn(1);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        ArrayList<Player> retiredPlayers = new ArrayList<>();
        ArrayList<Player> retiredPlayers1 = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);
        retiredPlayers.add(player2);
        //retiredPlayers.add(player2);
        retiredPlayers1.add(player1);
        retiredPlayers1.add(player2);

        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);
        when(gameModel.getRetiredPlayers()).thenReturn(retiredPlayers);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleWaitNextPhaseMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        message.getClientId().equals("Player1")
        ));
    }


    @Test
    public void handleWaitNextPhaseMessageTest2() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getFaseCounter()).thenReturn(2);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);


        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleWaitNextPhaseMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        message.getClientId().equals("Player2")
        ));
    }

    @Test
    public void handleWaitNextPhaseMessageTest4() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getLevel()).thenReturn(2);
        when(combatZoneCard.getFaseCounter()).thenReturn(3);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);


        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.handleWaitNextPhaseMessage("Player1", combatZoneCard);

        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof AskRollDiceMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof SetCardInUseMessage &&
                        message.getClientId().equals("Player2")
        ));
        verify(controller).update(argThat(message ->
                message instanceof DrawnCardMessage &&
                        message.getClientId().equals("Player2")
        ));
    }



    @Test
    public void getGameModelTest() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        controller.getGameModel();
    }



    @Test
    public void onMessageReceivedTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        FinishedBuildingMessage message1 = mock(FinishedBuildingMessage.class);
        PickUpCardMessage message2 = mock(PickUpCardMessage.class);
        RetireMessage message3 = mock(RetireMessage.class);
        FinishedPopulateMessage message4 = mock(FinishedPopulateMessage.class);
        WaitProceedMessage message5 = mock(WaitProceedMessage.class);
        controller.onMessageReceived(message1);
        controller.onMessageReceived(message2);
        controller.onMessageReceived(message3);
        controller.onMessageReceived(message4);
        controller.onMessageReceived(message5);
    }

    @Test
    public void onPlayerCountReachedTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        controller.onPlayerCountReached();
    }

    @Test
    public void onPutFiguresInShipTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getLevel()).thenReturn(2);
        when(combatZoneCard.getFaseCounter()).thenReturn(3);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getNickname()).thenReturn("Player1");
        when(player2.getNickname()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        ArrayList<String> ids = new ArrayList<>();
        ids.add("Player1");
        ids.add("Player2");

        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);


        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getIds()).thenReturn(ids);
        when(gameModel.getNicknames()).thenReturn(ids);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getConnectedPlayers()).thenReturn(2);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.onPutFiguresInShip();

        verify(controller).update(argThat(message ->
                message instanceof ClearPageMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ClearPageMessage &&
                        message.getClientId().equals("Player2")
        ));
    }

    @Test
    public void onPlayerShipBoardCorrectTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getLevel()).thenReturn(2);
        when(combatZoneCard.getFaseCounter()).thenReturn(3);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getNickname()).thenReturn("Player1");
        when(player2.getNickname()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        ArrayList<String> ids = new ArrayList<>();
        ids.add("Player1");
        ids.add("Player2");

        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);


        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getIds()).thenReturn(ids);
        when(gameModel.getNicknames()).thenReturn(ids);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getConnectedPlayers()).thenReturn(2);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.onPlayerShipBoardCorrect();
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ProceedNextCardMessage &&
                        message.getClientId().equals("Player2")
        ));
    }


    @Test
    public void initGameTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getLevel()).thenReturn(2);
        when(combatZoneCard.getFaseCounter()).thenReturn(3);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getNickname()).thenReturn("Player1");
        when(player2.getNickname()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        ArrayList<String> ids = new ArrayList<>();
        ids.add("Player1");
        ids.add("Player2");

        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);


        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getIds()).thenReturn(ids);
        when(gameModel.getNicknames()).thenReturn(ids);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getConnectedPlayers()).thenReturn(2);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);

        controller.initGame(null);

        verify(controller).update(argThat(message ->
                message instanceof ClearPageMessage &&
                        message.getClientId().equals("Player1")
        ));
        verify(controller).update(argThat(message ->
                message instanceof ClearPageMessage &&
                        message.getClientId().equals("Player2")
        ));
    }


    @Test
    public void finishGameTest0() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getLevel()).thenReturn(2);
        when(combatZoneCard.getFaseCounter()).thenReturn(3);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getNickname()).thenReturn("Player1");
        when(player2.getNickname()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        ArrayList<String> ids = new ArrayList<>();
        ids.add("Player1");
        ids.add("Player2");

        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);


        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getFlightType()).thenReturn(FlightType.FIRST_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getIds()).thenReturn(ids);
        when(gameModel.getNicknames()).thenReturn(ids);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getConnectedPlayers()).thenReturn(2);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);


        controller.finishGame();
    }

    @Test
    public void finishGameTest1() throws IOException, NoSuchFieldException, IllegalAccessException {
        controller = spy(new Controller(server));

        CombatZone combatZoneCard = mock(CombatZone.class);
        when(combatZoneCard.getCardType()).thenReturn(CardName.COMBAT_ZONE);
        when(combatZoneCard.getLevel()).thenReturn(2);
        when(combatZoneCard.getFaseCounter()).thenReturn(3);

        FlightBoard flightBoard = mock(FlightBoard.class);

        Player player1 = mock(Player.class);
        Player player2 = mock(Player.class);
        when(player1.getId()).thenReturn("Player1");
        when(player2.getId()).thenReturn("Player2");
        when(player1.getNickname()).thenReturn("Player1");
        when(player2.getNickname()).thenReturn("Player2");
        when(player1.getPlayerState()).thenReturn(PlayerState.REMOVE_GOOD);
        when(player1.getProceed()).thenReturn(true);
        when(player2.getProceed()).thenReturn(true);

        ArrayList<String> ids = new ArrayList<>();
        ids.add("Player1");
        ids.add("Player2");

        when(player1.getToBeRetiredFlag()).thenReturn(true);

        ArrayList<Player> players = new ArrayList<>();
        ArrayList<Player> playersPositions = new ArrayList<>();
        players.add(player1);
        players.add(player2);
        playersPositions.add(player1);
        playersPositions.add(player2);


        when(gameModel.getGameState()).thenReturn(GameState.PLAYING);
        when(gameModel.getFlightType()).thenReturn(FlightType.STANDARD_FLIGHT);
        when(gameModel.getPlayerInTurn()).thenReturn(player1);
        when(gameModel.getIds()).thenReturn(ids);
        when(gameModel.getNicknames()).thenReturn(ids);
        when(gameModel.getFlightBoard()).thenReturn(flightBoard);
        when(gameModel.getPlayers()).thenReturn(players);
        when(gameModel.getConnectedPlayers()).thenReturn(2);
        when(gameModel.getPlayersPosition()).thenReturn(playersPositions);

        ShipBoard shipBoard1 = mock(ShipBoard.class);
        ShipBoard shipBoard2 = mock(ShipBoard.class);
        when(player1.getShipBoard()).thenReturn(shipBoard1);
        when(player2.getShipBoard()).thenReturn(shipBoard2);

        Field gameModelField = Controller.class.getDeclaredField("gameModel");
        gameModelField.setAccessible(true);
        gameModelField.set(controller, gameModel);


        controller.finishGame();
    }
}